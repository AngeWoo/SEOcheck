<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SEO å¥æª¢å°å·¥å…·ï¼ˆPro ç‰ˆï¼‹GEOï¼šGenerative Engine Optimizationï¼‰</title>
<meta name="description" content="è¼¸å…¥ç¶²å€æˆ–è²¼ä¸ŠåŸå§‹ç¢¼é€²è¡Œ SEO å¥æª¢ï¼šTechnical / On-Page / GEOï¼ˆGenerative Engine Optimizationï¼‰/ Off-Pageï¼Œä¸¦ç”¢å‡ºå¯ç›´æ¥è²¼ä¸Šçš„ä¿®è£œç¯„ä¾‹ã€‚">

<style>
  :root{
    --bg:#0b1020;--bg-2:#0f172a;--panel:#0e1526;--muted:#94a3b8;--ink:#e5e7eb;
    --ok:#22c55e;--ok-weak:#0f2d1d;--warn:#f59e0b;--warn-weak:#2c220a;--bad:#ef4444;--bad-weak:#341214;
    --border:rgba(255,255,255,.10);--border-weak:rgba(255,255,255,.06);--card:#0c1426;--link:#60a5fa;
    --chip:#0f1a30;--chip-bd:rgba(255,255,255,.12);
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:radial-gradient(1200px 800px at 20% -10%,#0b1430,transparent),linear-gradient(180deg,#0b1020,#0b1220 40%,#0f172a);color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC","Helvetica Neue",Arial;}
  a{color:var(--link);text-decoration:none} a:hover{text-decoration:underline}
  .wrap{max-width:1280px;margin:32px auto;padding:0 18px}

  .card{background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.03));border:1px solid var(--border);border-radius:20px;box-shadow:0 22px 50px rgba(0,0,0,.35)}
  .head{padding:22px 22px 0}
  .title{font-size:22px;font-weight:800;letter-spacing:.3px}
  .sub{color:var(--muted);font-size:14px;margin-top:6px}
  .body{padding:18px 22px 22px}

  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  input[type=url], textarea{
    width:100%;flex:1 1 560px;background:#0b1220;color:var(--ink);
    border:1px solid var(--border);border-radius:12px;padding:14px;font-size:14px;outline:none;
  }
  input[type=url]::placeholder,textarea::placeholder{color:#70809a}
  textarea{min-height:160px;display:none}
  .btn{
    background:linear-gradient(135deg,#2563eb,#7c3aed);border:none;color:white;font-weight:700;
    padding:12px 16px;border-radius:12px;cursor:pointer;transition:transform .06s ease,opacity .2s,box-shadow .2s;
    box-shadow:0 6px 24px rgba(37,99,235,.25);
  }
  .btn.secondary{background:#1f2937;box-shadow:none}
  .btn.ghost{background:transparent;border:1px solid var(--border);box-shadow:none}
  .btn:active{transform:scale(.98)}
  .hint{font-size:12px;color:var(--muted);margin-top:8px}

  .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:16px;margin-top:16px}
  @media (max-width:1100px){.grid{grid-template-columns:1fr}}
  .sec{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));border:1px solid var(--border);border-radius:16px;padding:14px}
  .sec h3{margin:0 0 10px 0;font-size:15px;display:flex;align-items:center;gap:10px}
  .sec h3 .meta{color:var(--muted);font-weight:500;font-size:12px}

  .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
  .chip{background:var(--chip);border:1px solid var(--chip-bd);padding:6px 10px;border-radius:999px;font-size:12px;color:#cbd5e1}
  .status{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0}

  .list{margin:4px 0 0 0;padding-left:0}
  .item{display:grid;grid-template-columns:auto 1fr;gap:10px;align-items:flex-start;padding:8px 10px;border-radius:10px;border:1px solid var(--border-weak);margin:6px 0;background:#0b1220}
  .item .icon{width:22px;height:22px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:13px}
  .ok .icon{background:var(--ok-weak);color:#86efac;border:1px solid rgba(34,197,94,.35)}
  .warn .icon{background:var(--warn-weak);color:#fde68a;border:1px solid rgba(245,158,11,.35)}
  .bad .icon{background:var(--bad-weak);color:#fecaca;border:1px solid rgba(239,68,68,.35)}
  .item .text{line-height:1.55;word-break:break-word}
  .links{color:var(--muted);font-size:12px;word-break:break-all}

  .ext{display:flex;flex-wrap:wrap;gap:10px}
  .ext a{padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#0c162a}

  .samples{margin-top:14px;display:flex;flex-direction:column;gap:10px}
  .sample-card{background:#0b1220;border:1px solid var(--border);border-radius:14px;overflow:hidden}
  .sample-head{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px dashed var(--border)}
  .sample-title{font-size:14px;font-weight:800}
  .sample-ctrls{display:flex;gap:8px;align-items:center}
  .copy-btn,.toggle-btn{font-size:12px;border:1px solid var(--chip-bd);padding:6px 10px;border-radius:8px;background:rgba(255,255,255,.06);color:#fff;cursor:pointer}
  .copy-btn:active,.toggle-btn:active{transform:scale(.98)}
  .sample-meta{display:flex;gap:6px;flex-wrap:wrap;padding:8px 12px}
  .tag{font-size:11px;border:1px solid var(--chip-bd);padding:3px 8px;border-radius:999px;background:rgba(255,255,255,.04)}
  .sample-note{color:var(--muted);font-size:12px;margin:0 12px 8px}
  pre{margin:0;padding:12px;background:#0a1020;border-top:1px solid var(--border-weak);max-height:360px;overflow:auto}
  code{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,"Courier New",monospace;font-size:12.5px;color:#d1e7ff;white-space:pre-wrap;word-break:break-word}

  .fab{position:fixed;right:18px;bottom:18px;display:flex;flex-direction:column;gap:10px;z-index:30}
  .fab .btn{padding:10px 12px;border-radius:10px}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="head">
      <div class="title">SEO å¥æª¢å°å·¥å…·ï¼ˆPro ç‰ˆï¼‹GEOï¼šGenerative Engine Optimizationï¼‰</div>
      <div class="sub">è¼¸å…¥ä»»ä¸€é é¢ç¶²å€ï¼Œç³»çµ±æŠ“å– HTML åˆ†æ Technicalï¼On-Pageï¼<b>GEOï¼ˆç”Ÿæˆå¼å¼•æ“å„ªåŒ–ï¼‰</b>ï¼Off-Pageï¼Œä¸¦è‡ªå‹•ç”¢å‡ºå¯è²¼ä¸Šçš„ä¿®è£œç¯„ä¾‹ã€‚CORS æ™‚å¯æ”¹ã€Œè²¼ä¸ŠåŸå§‹ç¢¼ã€ã€‚</div>
    </div>
    <div class="body">
      <div class="row">
        <input id="urlInput" type="url" placeholder="ä¾‹å¦‚ï¼šhttps://www.example.com/your-page" />
        <button id="analyzeBtn" class="btn">åˆ†æ</button>
        <button id="toggleRawBtn" class="btn secondary">è²¼ä¸ŠåŸå§‹ç¢¼</button>
      </div>
      <textarea id="rawHtml" placeholder="å°‡æ•´é  HTML åŸå§‹ç¢¼è²¼åˆ°é€™è£¡ï¼Œç„¶å¾ŒæŒ‰ã€åˆ†æã€"></textarea>
      <div class="hint">æª¢æŸ¥ï¼štitle/description/H1/canonical/JSON-LD/OG/Twitter/hreflang/ALT/robots.txt/sitemap/HTTPS/GA4/viewport/lang + <b>GEO æŒ‡æ¨™ï¼ˆFAQå¯æŠ½å–åº¦ã€TL;DRã€Referencesã€Author/æ›´æ–°æ—¥æœŸã€Speakableã€HowToã€è¡¨æ ¼/è¦é»ã€éŒ¨é»/ç›®éŒ„ã€æ¬Šå¨å¤–é€£â€¦ï¼‰</b>ã€‚</div>

      <div id="status" class="chips"></div>

      <div class="grid" id="results" style="display:none">
        <section class="sec" id="sec-tech">
          <h3>æŠ€è¡“é¢ï¼ˆTechnicalï¼‰ <span class="meta" id="techScore"></span></h3>
          <div id="techItems" class="list"></div>
          <div class="hr" style="height:1px;background:var(--border);margin:12px 0"></div>
          <div class="ext small">å¤–éƒ¨æª¢æ¸¬ï¼š<span id="extLinks" class="ext"></span></div>
          <div class="samples" id="techSamples"></div>
        </section>

        <section class="sec" id="sec-onpage">
          <h3>å…§å®¹èˆ‡é é¢ï¼ˆOn-Pageï¼‰ <span class="meta" id="onScore"></span></h3>
          <div id="onItems" class="list"></div>
          <div class="samples" id="onSamples"></div>
        </section>

        <!-- GEO / Generative Engine Optimization -->
        <section class="sec" id="sec-geo" style="grid-column:1/-1">
          <h3>GEOï¼ˆGenerative Engine Optimizationï¼šç”Ÿæˆå¼å¼•æ“å„ªåŒ–ï¼‰ <span class="meta" id="geoScore"></span></h3>
          <div id="geoItems" class="list"></div>
          <div class="samples" id="geoSamples"></div>
        </section>

        <section class="sec" id="sec-offpage" style="grid-column:1/-1">
          <h3>å¤–éƒ¨èˆ‡å“ç‰Œï¼ˆOff-Page åŸºç¤å¯è¦‹åº¦ï¼‰ <span class="meta" id="offScore"></span></h3>
          <div id="offItems" class="list"></div>
          <div class="item warn">
            <div class="icon">â„¹ï¸</div>
            <div class="text muted">åå‘é€£çµ/å“ç‰ŒæåŠéœ€ç”¨ Ahrefs / Semrush / GSC æª¢è¦–ï¼›ä¸‹æ–¹æä¾›ã€Œç«™å…§å¯åšã€çš„åŸºç¤æ¨£æ¿ï¼ˆå¦‚å¯è¢«å¼•ç”¨çš„ç ”ç©¶é ï¼‰ã€‚</div>
          </div>
          <div class="samples" id="offSamples"></div>
        </section>
      </div>

      <div class="status" id="downloadBox" style="display:none">
        <button id="dlJson" class="btn secondary">ä¸‹è¼‰ JSON å ±å‘Š</button>
        <span class="chip">æƒææ™‚é–“ï¼š<span id="scanTime"></span></span>
        <span class="chip">URLï¼š<span id="scanUrl"></span></span>
      </div>
    </div>
  </div>
</div>

<div class="fab">
  <button id="toggleAll" class="btn secondary">æ”¶åˆ æ‰€æœ‰ç¯„ä¾‹</button>
  <button id="backTop" class="btn ghost" onclick="window.scrollTo({top:0,behavior:'smooth'})">å›åˆ°é ‚ç«¯ â¤´</button>
</div>

<script>
/* ====== DOM å¿«æ· ====== */
const $ = s => document.querySelector(s);
const urlInput = $('#urlInput');
const analyzeBtn = $('#analyzeBtn');
const toggleRawBtn = $('#toggleRawBtn');
const rawHtml = $('#rawHtml');

const results = $('#results');
const techItems = $('#techItems');
const onItems = $('#onItems');
const offItems = $('#offItems');
const geoItems = $('#geoItems');

const techSamples = $('#techSamples');
const onSamples = $('#onSamples');
const offSamples = $('#offSamples');
const geoSamples = $('#geoSamples');

const extLinks = $('#extLinks');
const dlBox = $('#downloadBox');
const dlJsonBtn = $('#dlJson');
const scanTime = $('#scanTime');
const scanUrl = $('#scanUrl');
const statusBox = $('#status');

const techScoreEl = $('#techScore');
const onScoreEl = $('#onScore');
const offScoreEl = $('#offScore');
const geoScoreEl = $('#geoScore');

const toggleAllBtn = $('#toggleAll');

toggleRawBtn.addEventListener('click', ()=>{
  rawHtml.style.display = rawHtml.style.display === 'none' || rawHtml.style.display === '' ? 'block' : 'none';
  toggleRawBtn.textContent = rawHtml.style.display === 'block' ? 'éš±è—åŸå§‹ç¢¼æ¬„ä½' : 'è²¼ä¸ŠåŸå§‹ç¢¼';
});

function norm(u){
  try{ let x=u.trim(); if(!/^https?:\/\//i.test(x)) x='https://'+x; return new URL(x).toString(); }
  catch(e){ return null; }
}

function itemRow(level, html){
  const wrap=document.createElement('div'); wrap.className=`item ${level}`;
  const icon=document.createElement('div'); icon.className='icon'; icon.textContent=level==='ok'?'âœ“':(level==='bad'?'âœ–':'âš ');
  const text=document.createElement('div'); text.className='text'; text.innerHTML=html;
  wrap.appendChild(icon); wrap.appendChild(text); return wrap;
}
function addItem(container, text){
  const level = text.startsWith('âœ…')?'ok':(text.startsWith('âŒ')?'bad':'warn');
  container.appendChild(itemRow(level, text));
}
function chip(text){ const s=document.createElement('span'); s.className='chip'; s.textContent=text; return s; }

/* ====== é–‹åˆæ§åˆ¶ ====== */
function setSampleOpen(preEl, open){
  preEl.style.display = open ? 'block' : 'none';
  preEl.dataset.open = open ? '1' : '0';
  const toggleBtn = preEl.closest('.sample-card')?.querySelector('.toggle-btn');
  if(toggleBtn){ toggleBtn.textContent = open ? 'æ”¶åˆ' : 'å±•é–‹'; }
}
function makeSampleCard({title, note, code, tags=[]}){
  const wrap=document.createElement('div'); wrap.className='sample-card';
  const head=document.createElement('div'); head.className='sample-head';
  const ttl=document.createElement('div'); ttl.className='sample-title'; ttl.textContent=title;
  const ctrls=document.createElement('div'); ctrls.className='sample-ctrls';
  const btnCopy=document.createElement('button'); btnCopy.className='copy-btn'; btnCopy.textContent='è¤‡è£½';
  const btnToggle=document.createElement('button'); btnToggle.className='toggle-btn'; btnToggle.textContent='æ”¶åˆ';
  ctrls.appendChild(btnCopy); ctrls.appendChild(btnToggle); head.appendChild(ttl); head.appendChild(ctrls);

  const tagsEl=document.createElement('div'); tagsEl.className='sample-meta';
  tags.forEach(t=>{ const span=document.createElement('span'); span.className='tag'; span.textContent=t; tagsEl.appendChild(span); });

  const noteEl=document.createElement('div'); noteEl.className='sample-note'; noteEl.textContent=note||'å°‡æ­¤ç‰‡æ®µè²¼å…¥å°æ‡‰ä½ç½®å³å¯ã€‚';

  const pre=document.createElement('pre'); const codeEl=document.createElement('code'); codeEl.textContent=code; pre.appendChild(codeEl);
  setSampleOpen(pre, true);

  btnCopy.addEventListener('click', ()=>{ navigator.clipboard.writeText(code).then(()=>{ btnCopy.textContent='å·²è¤‡è£½'; setTimeout(()=>btnCopy.textContent='è¤‡è£½',1500); }); });
  btnToggle.addEventListener('click', ()=>{ const isOpen=pre.dataset.open==='1'; setSampleOpen(pre, !isOpen); });

  wrap.appendChild(head); if(tags.length) wrap.appendChild(tagsEl); wrap.appendChild(noteEl); wrap.appendChild(pre); return wrap;
}
function renderSamplesTo(targetEl, samples){ samples.forEach(s=> targetEl.appendChild(makeSampleCard(s))); }

/* ====== æŠ“å– ====== */
async function fetchWithFallbacks(targetUrl){
  try{ const r=await fetch(targetUrl,{mode:'cors'}); if(r.ok) return await r.text(); }catch(e){}
  const proxies=[`https://r.jina.ai/http://`+targetUrl.replace(/^https?:\/\//,''), `https://r.jina.ai/`+targetUrl];
  for(const p of proxies){ try{ const r=await fetch(p); if(r.ok) return await r.text(); }catch(e){} }
  throw new Error('æŠ“å–å¤±æ•—ã€‚å¯æ”¹ç”¨ã€Œè²¼ä¸ŠåŸå§‹ç¢¼ã€æ¨¡å¼ã€‚');
}

/* ====== æ ¸å¿ƒåˆ†æ ====== */
function analyzeHTML(html, baseUrl){
  const parser=new DOMParser(); const doc=parser.parseFromString(html,'text/html');

  const rep={ url:baseUrl, time:new Date().toISOString(), summary:{}, technical:[], onpage:[], offpage:[], geo:[], scores:{technical:0,onpage:0,offpage:0,geo:0}, samples:{tech:[], on:[], off:[], geo:[]} };

  const get = sel => doc.querySelector(sel);
  const getAll = sel => Array.from(doc.querySelectorAll(sel));

  const title=(doc.title || (get('title')?.textContent ?? '')).trim();
  const metaDesc=get('meta[name="description"]')?.getAttribute('content')||'';
  const metaRobots=get('meta[name="robots"]')?.getAttribute('content')||'';
  const canon=get('link[rel="canonical"]')?.getAttribute('href')||'';
  const ogTitle=get('meta[property="og:title"]')?.getAttribute('content')||'';
  const ogDesc=get('meta[property="og:description"]')?.getAttribute('content')||'';
  const ogImg=get('meta[property="og:image"]')?.getAttribute('content')||'';
  const twCard=get('meta[name="twitter:card"]')?.getAttribute('content')||'';
  const twImg=get('meta[name="twitter:image"], meta[property="twitter:image"]')?.getAttribute('content')||'';
  const h1s=getAll('h1'); const imgs=getAll('img'); const links=getAll('a[href]');
  const langAttr=doc.documentElement.getAttribute('lang')||'';
  const viewport=get('meta[name="viewport"]')?.getAttribute('content')||'';
  const gVerify=get('meta[name="google-site-verification"]')?.getAttribute('content')||'';
  const scripts=getAll('script');
  const hasGA4=scripts.some(s=>/gtag\(\s*['"]config['"]\s*,\s*['"]G-[A-Z0-9]+['"]\s*\)/.test(s.textContent||''));
  const hasUA=scripts.some(s=>/ga\('create'|UA-\d+-\d+'?/.test(s.textContent||''));
  const jsonLd=getAll('script[type="application/ld+json"]').map(s=>{ try{ return JSON.parse(s.textContent); }catch(e){ return null; } }).filter(Boolean);
  const hreflangs=getAll('link[rel="alternate"][hreflang]');

  const host=safeHost(baseUrl); const urlOrigin=safeOrigin(baseUrl)||'https://www.example.com'; const pageUrl=baseUrl||'https://www.example.com/your-page';

  const pushFix=(bucket,title,code,note='',tags=[])=>{
    const fix={title,code,note,tags};
    (bucket==='tech'?rep.samples.tech:bucket==='on'?rep.samples.on:bucket==='geo'?rep.samples.geo:rep.samples.off).push(fix);
  };

  /* --- Technical / On-Pageï¼ˆå’Œå‰ç‰ˆç›¸åŒï¼Œç¯€éŒ„å¿…è¦åŠ åˆ†ï¼‰ --- */
  if(/noindex/i.test(metaRobots)){ rep.technical.push('âŒ åµæ¸¬åˆ° <span class="mono">meta[name="robots"]</span>ï¼šnoindexã€‚'); pushFix('on','ç§»é™¤ noindex',`<meta name="robots" content="index,follow">`,'åƒ…ä¸éœ€ç´¢å¼•çš„é é¢æ‰ç”¨ noindexã€‚',['robots']); }
  else { rep.technical.push('âœ… æœªç™¼ç¾ noindexï¼Œç†è«–ä¸Šå¯è¢«ç´¢å¼•ã€‚'); rep.scores.technical += 1; }

  if(!title){ rep.onpage.push('âŒ ç¼ºå°‘ <span class="mono">&lt;title&gt;</span>ã€‚'); pushFix('on','æ–°å¢ <title>',`<title>ä¸»é—œéµå­—ï½œåƒ¹å€¼ä¸»å¼µèˆ‡æ¬¡é—œéµå­—ï¼ˆ35â€“60å­—å…§ï¼‰</title>`,'é—œéµå­—é å‰ï¼Œå¾Œæ®µåŠ å“ç‰Œã€‚',['title']); }
  else { const len=[...title].length; if(len<10||len>60){ rep.onpage.push(`âš ï¸ <span class="mono">&lt;title&gt;</span> é•·åº¦ç‚º ${len}ã€‚`); pushFix('on','èª¿æ•´é•·åº¦',`<title>${title.slice(0,56)}ï½œä½ çš„å“ç‰Œ</title>`,`é¿å…è¢«æˆªæ–·ã€‚`,['title']); } else { rep.onpage.push('âœ… <span class="mono">&lt;title&gt;</span> é•·åº¦åˆç†ã€‚'); rep.scores.onpage += 1; } }

  if(!metaDesc){ rep.onpage.push('âŒ ç¼ºå°‘ <span class="mono">meta description</span>ã€‚'); pushFix('on','æ–°å¢ description',`<meta name="description" content="80â€“160å­—å…§ï¼Œèªªæ¸…æ¥šè§£æ±ºå•é¡Œã€èª°é©ç”¨èˆ‡è¡Œå‹•å‘¼ç±²ã€‚">`,'æå‡ CTRã€‚',['description']); }
  else { const len=[...metaDesc].length; if(len<50||len>160){ rep.onpage.push(`âš ï¸ description é•·åº¦ç‚º ${len}ã€‚`); pushFix('on','å„ªåŒ– description',`<meta name="description" content="${metaDesc.slice(0,156)}">`,'å£“åˆ° 160 å­—å…§ã€‚',['description']); } else { rep.onpage.push('âœ… description é•·åº¦åˆç†ã€‚'); rep.scores.onpage += 1; } }

  if(!canon){ rep.technical.push('âš ï¸ ç¼ºå°‘ <span class="mono">canonical</span>ã€‚'); pushFix('tech','æ–°å¢ canonical',`<link rel="canonical" href="${pageUrl}">`,'æŒ‡å‘æ­£è¦ URLã€‚',['canonical']); }
  else { rep.technical.push(`âœ… ç™¼ç¾ canonicalï¼š<span class="mono">${escapeHtml(canon)}</span>ã€‚`); rep.scores.technical += 1; }

  /* --- GEOï¼šGenerative Engine Optimization æª¢æŸ¥ --- */
  const bodyText=(doc.body?.innerText||'').replace(/\s+/g,' ').trim();
  const h2h3 = getAll('h2, h3');
  const h2h3Count = h2h3.length;
  const h2h3WithId = h2h3.filter(h=>h.id).length;

  // 1) FAQ æŠ½å–åº¦
  const hasFAQSchema = jsonLd.some(o=>hasType(o,'FAQPage'));
  const faqHeading = h2h3.some(h=>/FAQ|å¸¸è¦‹å•é¡Œ|Q&A|å•èˆ‡ç­”/i.test(h.textContent||''));
  if(hasFAQSchema || faqHeading){ rep.geo.push('âœ… FAQ å€å¡Š/FAQPage å·²è¨­ç½®ï¼ˆæœ‰åŠ© LLM ä»¥ Qâ†’A ç›´æ¥æŠ½å–ï¼‰ã€‚'); rep.scores.geo += 1; }
  else{
    rep.geo.push('âš ï¸ æœªåµæ¸¬åˆ° FAQ å€å¡Šæˆ– FAQPage JSON-LDã€‚');
    pushFix('geo','FAQPage JSON-LDï¼ˆå¯ç›´æ¥æŠ½å–ï¼‰',`<script type="application/ld+json">
{
 "@context":"https://schema.org",
 "@type":"FAQPage",
 "mainEntity":[
  {"@type":"Question","name":"ä½ çš„ç”¢å“é©ç”¨å“ªäº›æƒ…å¢ƒï¼Ÿ","acceptedAnswer":{"@type":"Answer","text":"åˆ—å‡º 3â€“5 å€‹å¸¸è¦‹æƒ…å¢ƒèˆ‡é™åˆ¶ã€‚"}},
  {"@type":"Question","name":"èˆ‡ç«¶å“å·®ç•°ï¼Ÿ","acceptedAnswer":{"@type":"Answer","text":"ç”¨è¡¨æ ¼èªªæ˜ä¸‰é …æ ¸å¿ƒå·®ç•°èˆ‡èª°è©²ç”¨ã€‚"}}
 ]
}
<\/script>`,'åŒé ä¹Ÿæ”¾å¯è¦‹çš„ FAQ å€å¡Šï¼ˆdetails/summary æˆ–åˆ—è¡¨ï¼‰ã€‚',['FAQ','JSON-LD']);
  }

  // 2) TL;DR / é‡é»æ•´ç†
  const hasTLDR = /TL;?DR|é‡é»æ•´ç†|å¿«é€Ÿç¸½çµ|æ‘˜è¦/i.test(bodyText);
  if(hasTLDR){ rep.geo.push('âœ… å­˜åœ¨ TL;DR / é‡é»æ•´ç†å€å¡Šã€‚'); rep.scores.geo += 1; }
  else{
    rep.geo.push('âš ï¸ æœªåµæ¸¬åˆ° TL;DR / é‡é»æ•´ç†ï¼ˆæœ‰åŠ©é›¶é»æ“Šç›´æ¥å›ç­”ï¼‰ã€‚');
    pushFix('geo','åŠ å…¥ TL;DRï¼ˆå¯è¦‹ HTMLï¼‰',`<section class="tldr" aria-label="é‡é»æ•´ç†">
  <h2>TL;DR é‡é»æ•´ç†</h2>
  <ul>
    <li>ä¸€å¥è©±å®šç¾©ï¼šâ‹¯â‹¯</li>
    <li>ä¸‰å€‹é—œéµæ­¥é©Ÿï¼šâ‹¯â‹¯</li>
    <li>å¸¸è¦‹å‘èˆ‡é¿å…æ–¹å¼ï¼šâ‹¯â‹¯</li>
  </ul>
</section>`,'æ”¾åœ¨æ–‡é¦–æˆ– H2 ä¹‹å‰ï¼Œæ–¹ä¾¿ LLM æ“·å–é—œéµé»ã€‚',['æ‘˜è¦','é›¶é»æ“Š']);
  }

  // 3) References / å‡ºè™•å¯é©—è­‰
  const refsHeading = h2h3.some(h=>/åƒè€ƒè³‡æ–™|References|ä¾†æº|å¼•è¨»/i.test(h.textContent||''));
  const extLinks = getAll('a[href]').filter(a=>{ try{ const u=new URL(a.href, baseUrl); return u.host && u.host!==host; }catch(e){return false;} });
  const authLinks = extLinks.filter(a=>/(\.gov|\.edu|wikipedia\.org|who\.int|doi\.org)/i.test(a.href||'')).length;
  if(refsHeading && authLinks>0){ rep.geo.push(`âœ… åƒè€ƒè³‡æ–™å€å¡Šä¸”å«æ¬Šå¨å¤–é€£ï¼ˆ${authLinks} ç­†ï¼‰ã€‚`); rep.scores.geo += 1; }
  else{
    rep.geo.push('âš ï¸ æœªè¦‹ã€Œåƒè€ƒè³‡æ–™ã€å€å¡Šæˆ–ç¼ºä¹æ¬Šå¨å¤–é€£ï¼ˆgov/edu/Wikipedia/DOIï¼‰ã€‚');
    pushFix('geo','åŠ å…¥ References å€å¡Šï¼ˆå«æ¬Šå¨å‡ºè™•ï¼‰',`<section id="references">
  <h2>åƒè€ƒè³‡æ–™</h2>
  <ol>
    <li><a href="https://en.wikipedia.org/wiki/..." rel="noopener">æ¦‚å¿µç¶­åŸºæ¢ç›®</a></li>
    <li><a href="https://doi.org/10.xxxx/xxxxx" rel="noopener">åŒè¡Œè©•å¯©è«–æ–‡ï¼ˆDOIï¼‰</a></li>
    <li><a href="https://www.gov.tw/..." rel="noopener">æ”¿åºœé–‹æ”¾è³‡æ–™</a></li>
  </ol>
</section>`,'LLM å–œæ­¡ã€Œå¯é©—è­‰ã€çš„é™³è¿°èˆ‡é€£çµã€‚',['References','E-E-A-T']);
  }

  // 4) Author / æ›´æ–°æ—¥æœŸ / Article schema
  const hasAuthorMeta = !!get('meta[name="author"]');
  const hasUpdatedMeta = !!get('meta[property="article:modified_time"], meta[name="last-modified"], time[datetime]');
  const hasArticleSchema = jsonLd.some(o=>hasType(o,'Article') || hasType(o,'BlogPosting'));
  if(hasAuthorMeta && hasUpdatedMeta && hasArticleSchema){ rep.geo.push('âœ… æœ‰ä½œè€…/æ›´æ–°æ—¥æœŸèˆ‡ Article é¡ schemaã€‚'); rep.scores.geo += 1; }
  else{
    rep.geo.push('âš ï¸ å»ºè­°è£œå……ä½œè€…ã€æ›´æ–°æ—¥æœŸèˆ‡ Article/BlogPosting schemaã€‚');
    pushFix('geo','Article + Authorï¼ˆJSON-LDï¼‰',`<script type="application/ld+json">
{
 "@context":"https://schema.org",
 "@type":"Article",
 "headline":"æ­¤é æ¨™é¡Œ",
 "datePublished":"2025-01-01",
 "dateModified":"2025-02-01",
 "author":{"@type":"Person","name":"ä½œè€…å","url":"${urlOrigin}/about/"},
 "publisher":{"@type":"Organization","name":"ä½ çš„å“ç‰Œ","logo":{"@type":"ImageObject","url":"${urlOrigin}/assets/logo.png"}}
}
<\/script>`,'é é¢å¯è¦‹è™•ä¹Ÿæ”¾ä½œè€…å°å¡ï¼‹æ›´æ–°æ—¥æœŸã€‚',['E-E-A-T','Author']);
  }

  // 5) Speakableï¼ˆå¯æœ—è®€ç‰‡æ®µï¼Œåˆ©èªéŸ³/æ‘˜è¦ï¼‰
  const hasSpeakable = jsonLd.some(o=>o.speakable);
  if(hasSpeakable){ rep.geo.push('âœ… å­˜åœ¨ speakable ç‰‡æ®µã€‚'); rep.scores.geo += 1; }
  else{
    rep.geo.push('â„¹ï¸ å¯é¸ï¼šåŠ å…¥ speakable ç‰‡æ®µï¼Œåˆ©èªéŸ³èˆ‡æ‘˜è¦ã€‚');
    pushFix('geo','Speakableï¼ˆJSON-LDï¼‰',`<script type="application/ld+json">
{
 "@context":"https://schema.org",
 "@type":"WebPage",
 "speakable":{
   "@type":"SpeakableSpecification",
   "cssSelector":[".tldr","h1"]
 }
}
<\/script>`,'å°‡æœ€é—œéµçš„å®šç¾©/çµè«–è¨­ç‚º speakableã€‚',['speakable']);
  }

  // 6) HowToï¼ˆæ­¥é©Ÿå‹å…§å®¹ï¼‰
  const hasHowTo = jsonLd.some(o=>hasType(o,'HowTo'));
  const hasStepsText = /æ­¥é©Ÿ|åšæ³•|How to|æ•™ç¨‹|æ•™å­¸/i.test(bodyText);
  if(hasHowTo || hasStepsText){ rep.geo.push('âœ… åµæ¸¬åˆ° HowTo å‹å…§å®¹æˆ–æ­¥é©Ÿæ–‡å­—ã€‚'); rep.scores.geo += 1; }
  else{
    rep.geo.push('â„¹ï¸ è‹¥ç‚ºæµç¨‹/æ•™å­¸ï¼Œå»ºè­°è£œ HowTo çµæ§‹åŒ–è³‡æ–™ã€‚');
    pushFix('geo','HowToï¼ˆJSON-LDï¼‰',`<script type="application/ld+json">
{
 "@context":"https://schema.org",
 "@type":"HowTo",
 "name":"å¦‚ä½•å®Œæˆ X",
 "step":[
  {"@type":"HowToStep","name":"æ­¥é©Ÿä¸€","text":"â€¦"},
  {"@type":"HowToStep","name":"æ­¥é©ŸäºŒ","text":"â€¦"}
 ]
}
<\/script>`,'åŒé ç”¨ <ol> æ¢åˆ—æ­¥é©Ÿï¼Œä¾¿æ–¼æŠ½å–ã€‚',['HowTo']);
  }

  // 7) å¯æŠ½å–çš„è¡¨æ ¼/è¦é»
  const tables = getAll('table').length;
  const hasBullets = getAll('ul li, ol li').length>0;
  if(tables>0 || hasBullets){ rep.geo.push('âœ… æœ‰è¡¨æ ¼/æ¢åˆ—è¦é»ï¼Œä¾¿æ–¼ LLM æ‘˜è¦ã€‚'); rep.scores.geo += 1; }
  else{
    rep.geo.push('âš ï¸ ç¼ºå°‘è¡¨æ ¼æˆ–æ¢åˆ—è¦é»ï¼ˆå»ºè­°æä¾›å¯æŠ½å–çš„çµæ§‹ï¼‰ã€‚');
    pushFix('geo','åŠ å…¥ã€Œé—œéµäº‹å¯¦è¡¨ã€',`<table class="facts">
  <thead><tr><th>è¦é»</th><th>æ•¸å€¼/çµè«–</th><th>ä¾†æº</th></tr></thead>
  <tbody>
    <tr><td>å®šç¾©</td><td>ä¸€å¥è©±å®šç¾© â€¦</td><td><a href="#references">Ref #1</a></td></tr>
    <tr><td>ä¸»è¦å·®ç•°</td><td>A vs B çš„ 3 é»å·®ç•°</td><td><a href="#references">Ref #2</a></td></tr>
  </tbody>
</table>`,'äº‹å¯¦è¡¨æ ¼å¯è¢«ç›´æ¥æŠ½å–æˆ key-valueã€‚',['è¡¨æ ¼','å¯æŠ½å–']);
  }

  // 8) éŒ¨é»/ç›®éŒ„ï¼ˆä¾¿æ–¼å®šä½æ®µè½ï¼‰
  const hasTOC = getAll('a[href^="#"]').length>5;
  if(h2h3WithId>0 && hasTOC){ rep.geo.push('âœ… æœ‰éŒ¨é»èˆ‡ç›®éŒ„ï¼Œåˆ©æ®µè½å®šä½ã€‚'); rep.scores.geo += 1; }
  else{
    rep.geo.push('â„¹ï¸ å»ºè­°ç‚º H2/H3 åŠ  id ä¸¦æä¾›ã€Œé é¢ç›®éŒ„ã€ã€‚');
    pushFix('geo','è‡ªå‹•ç›®éŒ„ï¼‹éŒ¨é»ç¯„ä¾‹',`<nav class="toc" aria-label="é é¢ç›®éŒ„">
  <ol>
    <li><a href="#def">ä»€éº¼æ˜¯ X</a></li>
    <li><a href="#steps">å¦‚ä½•æ“ä½œ</a></li>
    <li><a href="#faq">å¸¸è¦‹å•é¡Œ</a></li>
  </ol>
</nav>
<h2 id="def">ä»€éº¼æ˜¯ X</h2>
<h2 id="steps">å¦‚ä½•æ“ä½œ</h2>
<h2 id="faq">å¸¸è¦‹å•é¡Œ</h2>`,'ç¢ºä¿ H2/H3 éƒ½æœ‰ç©©å®šçš„ idã€‚',['éŒ¨é»','ç›®éŒ„']);
  }

  // 9) åœ–ç‰‡æè¿°/åœ–èªªï¼ˆåˆ©è¦–è¦ºæ‘˜è¦ï¼‰
  const hasFigcaption = getAll('figure figcaption').length>0;
  if(hasFigcaption){ rep.geo.push('âœ… åœ–ç‰‡å…· figcaptionï¼ˆåœ–èªªå¯è¢«å¼•ç”¨ï¼‰ã€‚'); rep.scores.geo += 1; }
  else if(getAll('img').length>0){
    rep.geo.push('â„¹ï¸ å»ºè­°ç‚ºé‡è¦åœ–ç‰‡åŠ ä¸Š <figure><figcaption>ã€‚');
    pushFix('geo','å¸¶åœ–èªªçš„åœ–åƒå€å¡Š',`<figure>
  <img src="/assets/og/diagram.webp" alt="X èˆ‡ Y çš„æµç¨‹åœ–">
  <figcaption>åœ– 1ï¼šX èˆ‡ Y çš„æµç¨‹å°ç…§ï¼Œé‡é»æ˜¯ â€¦</figcaption>
</figure>`,'åœ–èªªæä¾›å¯å¼•ç”¨çš„ä¸€å¥è©±é‡é»ã€‚',['åœ–èªª']);
  }

  // 10) å…§å®¹å¯†åº¦ï¼ˆéé•·æ®µè½ä¸åˆ©æŠ½å–ï¼‰
  const paragraphs = getAll('p').map(p=> (p.textContent||'').trim()).filter(t=>t);
  const avgLen = paragraphs.length? Math.round(paragraphs.join(' ').length/paragraphs.length) : 0;
  if(avgLen && avgLen<=380){ rep.geo.push(`âœ… æ®µè½å¹³å‡é•·åº¦ ${avgLen} å­—ï¼Œåˆ©æŠ½å–ã€‚`); rep.scores.geo += 1; }
  else if(avgLen){
    rep.geo.push(`âš ï¸ æ®µè½å¹³å‡é•·åº¦ç´„ ${avgLen} å­—ï¼Œå»ºè­°æ¯æ®µ 80â€“300 å­—ä»¥å…§ã€‚`);
    pushFix('geo','é‡æ§‹ç‚ºã€Œå°æ®µè½ï¼‹å°æ¨™é¡Œã€',`<h3>å°ç¯€æ¨™é¡Œï¼ˆå«é—œéµè©ï¼‰</h3>
<p>80â€“150å­—ï¼šå…ˆçµ¦ç­”æ¡ˆï¼Œå†è£œç†ç”±ã€‚</p>
<ul><li>è¦é» 1</li><li>è¦é» 2</li><li>è¦é» 3</li></ul>`,'æå‡èªç¾©å¯†åº¦èˆ‡æŠ½å–å‹å–„åº¦ã€‚',['å¯è®€æ€§']);
  } else {
    rep.geo.push('â„¹ï¸ æœªèƒ½ä¼°ç®—æ®µè½é•·åº¦ï¼ˆé é¢ p æ¨™ç±¤åå°‘ï¼‰ã€‚');
  }

  /* --- Off-pageï¼šä¿ç•™ --- */
  rep.offpage.push('ğŸ“Œ å»ºç«‹å¯è¢«å¼•ç”¨çš„ç ”ç©¶/æ•¸æ“šé ï¼Œä½œç‚ºè‡ªç„¶å¤–éˆç£éµã€‚');
  pushFix('off','å¯è¢«å¼•ç”¨çš„æ•¸æ“šé æ¨¡æ¿',`<article class="report">
  <h1>2025 æ¥­ç•ŒåŸºæº–å ±å‘Šï¼šä¸»è¦æŒ‡æ¨™èˆ‡è¶¨å‹¢</h1>
  <p>æ‘˜è¦ï¼šæœ¬å ±å‘Šå½™æ•´ X å®¶å» å•† / Y ä»½æ¡ˆä¾‹ï¼Œæä¾›å¯å¼•ç”¨ä¹‹æ•¸æ“šåœ–è¡¨ã€‚</p>
  <h2>é‡é»ç™¼ç¾</h2>
  <ul><li>æŒ‡æ¨™ A ä¸­ä½æ•¸ï¼š42%</li><li>æŒ‡æ¨™ B å¹³å‡æˆé•·ï¼š+18%</li></ul>
  <h2>åœ–è¡¨èˆ‡æ–¹æ³•</h2>
  <img src="/reports/2025/fig-1.webp" alt="æŒ‡æ¨™A åˆ†ä½ˆåœ–">
  <p>å¼•ç”¨æ ¼å¼ï¼šå“ç‰Œåï¼ˆ2025ï¼‰ï¼Œã€Š2025 æ¥­ç•ŒåŸºæº–å ±å‘Šã€‹ï¼Œé ç¢¼/åœ–è™Ÿã€‚</p>
</article>`,'ç™¼å¸ƒæ™‚æ­é…åª’é«”ç¨¿/ç¤¾ç¾¤è²¼æ–‡ä»¥æé«˜å¼•ç”¨ç‡ã€‚',['PR','å¤–éˆ']);

  /* --- robots / sitemapï¼ˆéé˜»å¡ï¼‰ --- */
  const u=new URL(baseUrl); rep.robots={}; rep.sitemap={};
  checkRobotsAndSitemap(u).then(({robotsInfo, sitemapInfo})=>{
    rep.robots=robotsInfo; rep.sitemap=sitemapInfo;
    appendRobotsSitemapToUI(robotsInfo, sitemapInfo, pushFix);
  });

  /* --- åˆ†æ•¸ --- */
  const techScore=Math.min(5,rep.scores.technical);
  const onScore=Math.min(6,rep.scores.onpage);
  const offScore=Math.min(3,rep.scores.offpage);
  const geoScore=Math.min(10,rep.scores.geo); // GEO æŒ‡æ¨™è¼ƒå¤šï¼Œæ»¿åˆ† 10
  rep.summary={technical:techScore,onpage:onScore,offpage:offScore,geo:geoScore};

  return rep;
}

/* ====== å°å·¥å…· ====== */
function hasType(node, type){
  if(!node) return false;
  const t=node['@type']; if(typeof t==='string') return t===type;
  if(Array.isArray(t)) return t.includes(type);
  return false;
}
function collectTypes(node){
  let out=[]; if(Array.isArray(node)){ node.forEach(n=>out=out.concat(collectTypes(n))); return out; }
  if(node && typeof node==='object'){
    const t=node['@type']; if(typeof t==='string') out.push(t); else if(Array.isArray(t)) out=out.concat(t.filter(x=>typeof x==='string'));
    for(const k of Object.keys(node)){ out=out.concat(collectTypes(node[k])); }
  } return out;
}
function toAbs(href, base){ try{ return new URL(href, base).toString(); }catch(e){ return href; } }
function safeHost(u){ try{ return new URL(u).host; }catch(e){ return ''; } }
function safeOrigin(u){ try{ return new URL(u).origin; }catch(e){ return ''; } }
function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m])); }

/* ====== robots / sitemap ====== */
async function checkRobotsAndSitemap(u){
  const robotsUrl = `${u.origin}/robots.txt`;
  const sitemapUrl = `${u.origin}/sitemap.xml`;
  const robotsInfo = {url: robotsUrl, ok:false, disallowAll:false, hasSitemap:false, sitemaps:[]};
  const sitemapInfo = {url: sitemapUrl, ok:false};

  try{
    const r = await fetch(`https://r.jina.ai/${robotsUrl}`);
    if(r.ok){
      const txt = await r.text();
      robotsInfo.ok = true; robotsInfo.text = txt;
      const disall = /Disallow:\s*\/\s*$/im.test(txt);
      robotsInfo.disallowAll = disall;
      const sitemaps = [...txt.matchAll(/Sitemap:\s*(.+)\s*$/img)].map(m=>m[1].trim());
      robotsInfo.hasSitemap = sitemaps.length>0; robotsInfo.sitemaps = sitemaps;
    }
  }catch(e){/*ignore*/}

  try{ const s = await fetch(`https://r.jina.ai/${sitemapUrl}`); sitemapInfo.ok = s.ok; }catch(e){/*ignore*/}

  return {robotsInfo, sitemapInfo};
}

function appendRobotsSitemapToUI(robotsInfo, sitemapInfo, pushFix){
  if(robotsInfo.ok){
    addItem(techItems, `âœ… è®€å– robots.txt æˆåŠŸï¼š<a class="links" href="${robotsInfo.url}" target="_blank">${robotsInfo.url}</a>`);
    if(robotsInfo.disallowAll){
      addItem(techItems, 'âŒ robots.txt å…¨ç«™ Disallowã€‚è«‹ç«‹åˆ»ä¿®æ­£ã€‚');
      pushFix('tech','ä¿®æ­£ robots.txtï¼ˆå…è¨±ç´¢å¼•ï¼‹å®£å‘Š Sitemapï¼‰',`User-agent: *
Disallow:

Sitemap: ${safeOrigin(robotsInfo.url)}/sitemap.xml`,'ç§»é™¤å…¨ç«™ Disallow ä¸¦åœ¨åº•éƒ¨å®£å‘Š Sitemapã€‚',['robots.txt']);
    }else{
      addItem(techItems, 'â„¹ï¸ robots.txt å…§å®¹å·²è®€å–ã€‚');
    }
    if(robotsInfo.hasSitemap){
      addItem(techItems, `âœ… robots.txt å®£å‘Š Sitemapï¼š<span class="mono">${robotsInfo.sitemaps.slice(0,3).join(', ')}</span>${robotsInfo.sitemaps.length>3?' â€¦':''}`);
    }else{
      addItem(techItems, 'âš ï¸ robots.txt æœªå®£å‘Š Sitemapã€‚');
      pushFix('tech','åœ¨ robots.txt å®£å‘Š Sitemap',`User-agent: *
Allow: /

Sitemap: ${safeOrigin(robotsInfo.url)}/sitemap.xml`,'å¹«åŠ©æœå°‹å¼•æ“æ›´å¿«ç™¼ç¾ç«™é»åœ°åœ–ã€‚',['robots.txt','Sitemap']);
    }
  }else{
    addItem(techItems, 'âš ï¸ ç„¡æ³•è®€å– robots.txtï¼ˆå¯èƒ½ä¸å­˜åœ¨ï¼‰ã€‚å»ºè­°å»ºç«‹ä¸¦é–‹æ”¾å¿…è¦è·¯å¾‘ã€‚');
    pushFix('tech','å»ºç«‹ robots.txt',`User-agent: *
Disallow: /admin/
Disallow: /cart/
Allow: /

Sitemap: ${safeOrigin(location.href) || 'https://www.example.com'}/sitemap.xml`,'ä¾å¯¦éš›å¾Œå°/éš±ç§è·¯å¾‘èª¿æ•´ Disallowã€‚',['robots.txt']);
  }

  if(sitemapInfo.ok){
    addItem(techItems, `âœ… åµæ¸¬åˆ°é è¨­ <a class="links" href="${sitemapInfo.url}" target="_blank">sitemap.xml</a>ã€‚`);
  }else{
    addItem(techItems, 'âš ï¸ æœªåµæ¸¬åˆ°é è¨­ <span class="mono">/sitemap.xml</span>ã€‚');
    pushFix('tech','éœæ…‹ sitemap ç¯„ä¾‹ï¼ˆXMLï¼‰',`<?xml version="1.0" encoding="UTF-8"?>
<urlset xmlns="https://www.sitemaps.org/schemas/sitemap/0.9">
  <url><loc>${safeOrigin(sitemapInfo.url) || 'https://www.example.com'}/</loc><lastmod>${new Date().toISOString().slice(0,10)}</lastmod><priority>1.0</priority></url>
  <url><loc>${safeOrigin(sitemapInfo.url) || 'https://www.example.com'}/about/</loc><lastmod>${new Date().toISOString().slice(0,10)}</lastmod><priority>0.8</priority></url>
</urlset>`,'å‹•æ…‹ç«™è«‹ç”±å¾Œç«¯å®šæœŸç”¢ç”Ÿèˆ‡æ›´æ–° lastmodã€‚',['Sitemap']);
  }

  renderSamples();
}

/* ====== æ¸²æŸ“å ±å‘Š ====== */
function renderReport(rep){
  results.style.display = 'grid';
  dlBox.style.display = 'flex';
  statusBox.innerHTML = '';
  techItems.innerHTML = onItems.innerHTML = offItems.innerHTML = '';
  geoItems.innerHTML = '';
  techSamples.innerHTML = onSamples.innerHTML = offSamples.innerHTML = geoSamples.innerHTML = '';

  rep.technical.forEach(t => addItem(techItems, t));
  rep.onpage.forEach(t => addItem(onItems, t));
  rep.offpage.forEach(t => addItem(offItems, t));
  rep.geo.forEach(t => addItem(geoItems, t));

  const enc = encodeURIComponent(rep.url);
  extLinks.innerHTML = `
    <a target="_blank" href="https://pagespeed.web.dev/report?url=${enc}">PageSpeedï¼ˆCWVï¼‰</a>
    <a target="_blank" href="https://search.google.com/test/rich-results?url=${enc}">Rich Results æ¸¬è©¦</a>
    <a target="_blank" href="view-source:${rep.url}">æª¢è¦–åŸå§‹ç¢¼</a>
  `;

  window.__report = rep; renderSamples();

  scanTime.textContent = new Date(rep.time).toLocaleString();
  scanUrl.textContent = rep.url;

  techScoreEl.textContent = `åˆ†æ•¸ï¼š${rep.summary.technical}/5`;
  onScoreEl.textContent = `åˆ†æ•¸ï¼š${rep.summary.onpage}/6`;
  geoScoreEl.textContent = `åˆ†æ•¸ï¼š${rep.summary.geo}/10`;
  offScoreEl.textContent = `åˆ†æ•¸ï¼š${rep.summary.offpage}/3`;

  dlJsonBtn.onclick = ()=>{
    const blob = new Blob([JSON.stringify(rep, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = `seo-geo-audit-${(new URL(rep.url)).host}.json`;
    document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url), 5000);
  };

  toggleAllBtn.textContent = 'æ”¶åˆ æ‰€æœ‰ç¯„ä¾‹';
}

function renderSamples(){
  const rep = window.__report; if(!rep) return;
  renderSamplesTo(techSamples, rep.samples.tech);
  renderSamplesTo(onSamples, rep.samples.on);
  renderSamplesTo(geoSamples, rep.samples.geo);
  renderSamplesTo(offSamples, rep.samples.off);
}

/* ====== ä¸€éµå±•é–‹/æ”¶åˆ ====== */
toggleAllBtn.addEventListener('click', ()=>{
  const pres = Array.from(document.querySelectorAll('.sample-card pre'));
  if(pres.length === 0) return;
  const anyOpen = pres.some(p => p.dataset.open === '1' || p.style.display === '' || p.style.display === 'block');
  const targetOpen = !anyOpen;
  pres.forEach(p => setSampleOpen(p, targetOpen));
  toggleAllBtn.textContent = targetOpen ? 'æ”¶åˆ æ‰€æœ‰ç¯„ä¾‹' : 'å±•é–‹ æ‰€æœ‰ç¯„ä¾‹';
});

/* ====== è§¸ç™¼åˆ†æ ====== */
analyzeBtn.addEventListener('click', async ()=>{
  const u = norm(urlInput.value || '');
  const pasted = rawHtml.value.trim();

  statusBox.innerHTML = '';
  results.style.display = 'none';
  dlBox.style.display = 'none';
  techItems.innerHTML = onItems.innerHTML = offItems.innerHTML = geoItems.innerHTML = '';
  techSamples.innerHTML = onSamples.innerHTML = offSamples.innerHTML = geoSamples.innerHTML = '';
  window.__report = null;

  if(!u && !pasted){ statusBox.appendChild(chip('è«‹å…ˆè¼¸å…¥ç¶²å€æˆ–è²¼ä¸ŠåŸå§‹ç¢¼')); return; }

  statusBox.appendChild(chip('åˆ†æä¸­â€¦'));
  try{
    const html = pasted || await fetchWithFallbacks(u);
    const rep = analyzeHTML(html, u || 'about:blank');
    renderReport(rep);
    statusBox.innerHTML = '';
  }catch(e){
    statusBox.innerHTML = '';
    statusBox.appendChild(chip('æŠ“å–å¤±æ•—ï¼š'+ (e?.message||e)));
    statusBox.appendChild(chip('æ”¹ç”¨ã€Œè²¼ä¸ŠåŸå§‹ç¢¼ã€é›¢ç·šåˆ†æå§'));
  }
});
</script>
</body>
</html>
