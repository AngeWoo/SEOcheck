<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®Œæ•´ SEO & GEO å„ªåŒ–æª¢æŸ¥å·¥å…·</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        .card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            margin-bottom: 30px;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }
        .header h1 { font-size: 2.5rem; margin-bottom: 10px; }
        .tabs { display: flex; background: #f5f5f5; }
        .tab { flex: 1; padding: 20px; background: none; border: none; font-size: 1rem; font-weight: 600; cursor: pointer; color: #666; border-bottom: 3px solid transparent; }
        .tab.active { color: #667eea; background: white; border-bottom-color: #667eea; }
        .content { padding: 40px; }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }
        input[type="url"], textarea { width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 10px; font-size: 1rem; margin-bottom: 15px; }
        input:focus, textarea:focus { outline: none; border-color: #667eea; }
        textarea { font-family: monospace; min-height: 300px; }
        #server-status { padding: 10px 15px; border-radius: 8px; margin-bottom: 15px; font-weight: 500; text-align: center; transition: all 0.3s ease; border: 1px solid transparent; }
        #server-status.status-ok { background-color: #dcfce7; color: #15803d; border-color: #4ade80; }
        #server-status.status-error { background-color: #fee2e2; color: #b91c1c; border-color: #f87171; text-align: left; }
        #server-status code { background-color: rgba(0,0,0,0.08); padding: 2px 6px; border-radius: 4px; font-family: monospace; }
        .btn { padding: 15px 30px; border: none; border-radius: 10px; font-size: 1rem; font-weight: 600; cursor: pointer; color: white; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .btn-success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); margin-right: 10px; }
        .btn-download { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); margin-right: 10px; }
        .btn-secondary { background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); }
        .results { display: none; }
        .results.show { display: block; }
        .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .summary-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 15px; text-align: center; }
        .summary-card h3 { font-size: 2.5rem; margin-bottom: 5px; }
        .summary-card p { opacity: 0.9; font-size: 0.9rem; }
        .section-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px 30px; margin: 30px 0 20px 0; border-radius: 10px; font-size: 1.5rem; font-weight: 700; }
        .subsection-header { background: #f3f4f6; padding: 15px 20px; margin: 20px 0 15px 0; border-radius: 8px; font-size: 1.2rem; font-weight: 700; color: #374151; border-left: 5px solid #667eea; }
        .check-item { background: white; border-radius: 10px; padding: 20px; margin-bottom: 15px; border: 2px solid #e5e7eb; }
        .check-item.good { border-left: 5px solid #10b981; background: #f0fdf4; }
        .check-item.warning { border-left: 5px solid #f59e0b; background: #fffbeb; }
        .check-item.error { border-left: 5px solid #ef4444; background: #fef2f2; }
        .check-title { font-weight: 700; font-size: 1.1rem; margin-bottom: 10px; }
        .status-badge { display: inline-block; width: 28px; height: 28px; border-radius: 50%; text-align: center; line-height: 28px; font-weight: 700; margin-right: 10px; }
        .good .status-badge { background: #10b981; color: white; }
        .warning .status-badge { background: #f59e0b; color: white; }
        .error .status-badge { background: #ef4444; color: white; }
        .check-value { background: #f9fafb; padding: 12px; border-radius: 8px; margin: 10px 0; font-family: monospace; font-size: 0.9rem; word-break: break-all; }
        .check-info { color: #6b7280; font-size: 0.95rem; margin: 8px 0; }
        .check-suggestion { background: #eff6ff; padding: 12px; border-radius: 8px; margin: 10px 0; color: #1e40af; font-size: 0.95rem; border-left: 3px solid #3b82f6; }
        .code-box { background: #1e293b; color: #e2e8f0; padding: 15px; border-radius: 8px; margin: 10px 0; font-family: monospace; font-size: 0.85rem; overflow-x: auto; white-space: pre-wrap; }
        .copy-btn { background: #10b981; color: white; border: none; padding: 6px 15px; border-radius: 5px; cursor: pointer; font-size: 0.85rem; margin-top: 8px; }
        .loading { text-align: center; padding: 40px; display: none; }
        .loading.show { display: block; }
        .spinner { border: 4px solid #f3f4f6; border-top: 4px solid #667eea; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .result-card { background: #f9fafb; border-radius: 15px; padding: 30px; margin-bottom: 30px; }
        .optimized-code, .optimized-code * { color: red !important; font-weight: bold; }
        .btn-copy-all { background: #10b981; color: white; border: none; padding: 8px 18px; border-radius: 8px; cursor: pointer; font-size: 0.9rem; font-weight: 600; }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="header"><h1>ğŸš€ å®Œæ•´ SEO & GEO å„ªåŒ–æª¢æŸ¥å·¥å…·</h1><p>è¶…é 50+ é …ç›®çš„å°ˆæ¥­ç´šæª¢æŸ¥</p></div>
            <div class="tabs">
                <button class="tab active" data-tab="url">ğŸ” åˆ†æç¶²å€</button>
                <button class="tab" data-tab="code">ğŸ’» è²¼ä¸ŠåŸå§‹ç¢¼</button>
            </div>
            <div class="content">
                <div id="url" class="tab-panel active">
                    <label style="display: block; font-weight: 600; margin-bottom: 10px;">è¼¸å…¥è¦åˆ†æçš„ç¶²å€</label>
                    <div id="server-status">æ­£åœ¨æª¢æŸ¥å¾Œç«¯ä¼ºæœå™¨é€£ç·š...</div>
                    <input type="url" id="urlInput" placeholder="https://example.com">
                    <div id="url-action-bar" style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                        <button id="url-analyze-btn" class="btn btn-primary" onclick="analyzeFromURL()">é–‹å§‹å®Œæ•´åˆ†æ</button>
                        <div id="url-results-buttons" style="display: none;">
                             <button class="btn btn-success" onclick="optimizeCode()">âš¡ ä¸€éµå„ªåŒ–å…¨éƒ¨</button>
                             <button class="btn btn-download" onclick="downloadCode()">â¬‡ï¸ ä¸‹è¼‰å„ªåŒ–ä»£ç¢¼</button>
                             <button class="btn btn-download" onclick="downloadSuggestions()">ğŸ“¥ ä¸‹è¼‰å„ªåŒ–å»ºè­°</button>
                             <button class="btn btn-secondary" onclick="window.location.reload()">ğŸ”„ é‡æ–°åˆ†æ</button>
                        </div>
                    </div>
                </div>
                <div id="code" class="tab-panel">
                    <label style="display: block; font-weight: 600; margin-bottom: 10px;">è²¼ä¸Š HTML åŸå§‹ç¢¼</label>
                    <textarea id="codeInput"></textarea>
                     <div id="code-action-bar" style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                        <button id="code-analyze-btn" class="btn btn-primary" onclick="analyzeFromCode()">é–‹å§‹å®Œæ•´åˆ†æ</button>
                        <div id="code-results-buttons" style="display: none;">
                             <button class="btn btn-success" onclick="optimizeCode()">âš¡ ä¸€éµå„ªåŒ–å…¨éƒ¨</button>
                             <button class="btn btn-download" onclick="downloadCode()">â¬‡ï¸ ä¸‹è¼‰å„ªåŒ–ä»£ç¢¼</button>
                             <button class="btn btn-download" onclick="downloadSuggestions()">ğŸ“¥ ä¸‹è¼‰å„ªåŒ–å»ºè­°</button>
                             <button class="btn btn-secondary" onclick="window.location.reload()">ğŸ”„ é‡æ–°åˆ†æ</button>
                        </div>
                    </div>
                </div>
                <div id="loading" class="loading"><div class="spinner"></div><p style="font-size: 1.1rem; font-weight: 600; color: #666;">æ­£åœ¨é€²è¡Œå®Œæ•´åˆ†æ...</p></div>
                <div id="results" class="results">
                    <div id="summary" class="summary-cards" style="margin-top: 30px;"></div>
                    <div class="result-card"><div id="checkResults"></div></div>
                    <div class="result-card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                             <h2 style="font-size: 1.8rem; margin: 0;">ğŸ’¾ å„ªåŒ–å¾Œçš„å®Œæ•´ä»£ç¢¼</h2>
                             <button class="btn-copy-all" onclick="copyFullCode()">ğŸ“‹ å…¨é¸è¤‡è£½ä»£ç¢¼</button>
                        </div>
                        <div class="code-box" style="min-height: 500px;"><pre><code id="outputCode" style="white-space: pre-wrap; word-wrap: break-word;"></code></pre></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        var htmlCode = '';
        var checkData = [];

        function checkServerStatus() {
            const statusEl = document.getElementById('server-status');
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 3000);
            fetch('http://localhost:3000/status', { signal: controller.signal })
                .then(response => { clearTimeout(timeoutId); if (!response.ok) throw new Error('ä¼ºæœå™¨å›æ‡‰éŒ¯èª¤'); return response.json(); })
                .then(data => { if (data.status === 'ok') { statusEl.textContent = 'âœ… å¾Œç«¯ä¼ºæœå™¨å·²é€£ç·š'; statusEl.className = 'status-ok'; } else { throw new Error('ä¾†è‡ªä¼ºæœå™¨çš„å›æ‡‰ç„¡æ•ˆ'); } })
                .catch(error => { clearTimeout(timeoutId); console.error('å¾Œç«¯ä¼ºæœå™¨ç‹€æ…‹æª¢æŸ¥å¤±æ•—:', error); statusEl.innerHTML = `âŒ <strong>å¾Œç«¯ä¼ºæœå™¨æœªå•Ÿå‹•ã€‚</strong><br>è«‹åœ¨çµ‚ç«¯æ©Ÿä¸­ï¼Œé€²å…¥å°ˆæ¡ˆè³‡æ–™å¤¾ä¸¦åŸ·è¡Œ <code>node server.js</code> æŒ‡ä»¤ã€‚`; statusEl.className = 'status-error'; });
        }
        document.addEventListener('DOMContentLoaded', checkServerStatus);

        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                var targetTab = this.getAttribute('data-tab');
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
                document.getElementById(targetTab).classList.add('active');
            });
        });

        function analyzeFromURL() {
            var url = document.getElementById('urlInput').value.trim();
            if (!url) { alert('è«‹è¼¸å…¥ç¶²å€'); return; }
            showLoading();
            fetch('http://localhost:3000/proxy?url=' + encodeURIComponent(url))
                .then(res => { if (!res.ok) throw new Error('ä¼ºæœå™¨å›æ‡‰éŒ¯èª¤: ' + res.status); return res.text(); })
                .then(html => { analyzeHTML(html, 'url'); hideLoading(); })
                .catch(err => { console.error('Fetch éŒ¯èª¤:', err); hideLoading(); alert('ç„¡æ³•ç²å–ç¶²é ï¼Œè«‹ç¢ºèªæ‚¨çš„å¾Œç«¯ä»£ç†ä¼ºæœå™¨ (server.js) æ˜¯å¦å·²å•Ÿå‹•'); checkServerStatus(); });
        }

        function analyzeFromCode() {
            var code = document.getElementById('codeInput').value.trim();
            if (!code) { alert('è«‹è²¼ä¸Š HTML ä»£ç¢¼'); return; }
            showLoading();
            setTimeout(() => { analyzeHTML(code, 'code'); hideLoading(); }, 500);
        }

        function safeText(el) { try { return el ? el.textContent.trim() : ''; } catch(e) { return ''; } }
        function safeAttr(el, attr) { try { return el ? (el.getAttribute(attr) || '') : ''; } catch(e) { return ''; } }

        function analyzeHTML(html, source) {
            htmlCode = html;
            checkData = [];
            try {
                var parser = new DOMParser(); var doc = parser.parseFromString(html, 'text/html');
                if (doc.querySelector('parsererror')) throw new Error('è§£æ HTML æ™‚ç™¼ç”ŸéŒ¯èª¤');
                
                checkData.push({ type: 'section', text: 'SEO å‚³çµ±æœå°‹å¼•æ“å„ªåŒ–' });
                checkData.push({ type: 'subsection', text: 'ğŸ“‹ åŸºç¤ Meta æ¨™ç±¤' });
                var titleEl = doc.querySelector('title'); var titleText = safeText(titleEl); var titleLen = titleText.length; checkData.push({ type: 'check', name: 'Title ç¶²é æ¨™é¡Œ', status: titleEl && titleLen >= 30 && titleLen <= 60 ? 'good' : titleEl ? 'warning' : 'error', value: titleText || 'æœªè¨­å®š', info: 'é•·åº¦: ' + titleLen + ' (å»ºè­° 30-60)', suggestion: titleLen < 30 ? 'æ¨™é¡Œå¤ªçŸ­' : titleLen > 60 ? 'æ¨™é¡Œå¤ªé•·' : '', code: '<title>ä¸»è¦é—œéµå­— | å“ç‰Œ</title>' });
                var descEl = doc.querySelector('meta[name="description"]'); var descText = safeAttr(descEl, 'content'); var descLen = descText.length; checkData.push({ type: 'check', name: 'Meta Description', status: descEl && descLen >= 120 && descLen <= 160 ? 'good' : descEl ? 'warning' : 'error', value: descText || 'æœªè¨­å®š', info: 'é•·åº¦: ' + descLen + ' (å»ºè­° 120-160)', suggestion: !descEl ? 'å¿…é ˆæ·»åŠ ' : descLen < 120 ? 'æè¿°å¤ªçŸ­' : descLen > 160 ? 'æè¿°å¤ªé•·' : '', code: '<meta name="description" content="æ¸…æ¥šæè¿°ç¶²é å…§å®¹...">' });
                var viewportEl = doc.querySelector('meta[name="viewport"]'); checkData.push({ type: 'check', name: 'Viewport éŸ¿æ‡‰å¼', status: viewportEl ? 'good' : 'error', value: safeAttr(viewportEl, 'content') || 'æœªè¨­å®š', info: viewportEl ? 'æ”¯æ´æ‰‹æ©Ÿ' : 'å¿…é ˆè¨­å®š', suggestion: !viewportEl ? 'å¿…é ˆæ·»åŠ ä»¥æ”¯æ´è¡Œå‹•è£ç½®' : '', code: '<meta name="viewport" content="width=device-width, initial-scale=1.0">' });
                var charsetEl = doc.querySelector('meta[charset]'); checkData.push({ type: 'check', name: 'Charset å­—å…ƒç·¨ç¢¼', status: charsetEl ? 'good' : 'error', value: safeAttr(charsetEl, 'charset') || 'æœªè¨­å®š', info: charsetEl ? 'æ­£ç¢ºè¨­å®š' : 'å¿…é ˆè¨­å®š', suggestion: !charsetEl ? 'å¿…é ˆæ·»åŠ  UTF-8' : '', code: '<meta charset="UTF-8">' });
                var hasLang = doc.documentElement.lang; checkData.push({ type: 'check', name: 'Language èªè¨€', status: hasLang ? 'good' : 'warning', value: hasLang || 'æœªè¨­å®š', info: hasLang ? 'å·²è¨­å®š' : 'å»ºè­°è¨­å®š', suggestion: !hasLang ? 'å»ºè­°æ¨™è¨˜èªè¨€' : '', code: '<html lang="zh-TW">' });
                var canonicalEl = doc.querySelector('link[rel="canonical"]'); checkData.push({ type: 'check', name: 'Canonical é€£çµè¦ç¯„', status: canonicalEl ? 'good' : 'warning', value: safeAttr(canonicalEl, 'href') || 'æœªè¨­å®š', info: 'é¿å…é‡è¤‡å…§å®¹å•é¡Œ', suggestion: !canonicalEl ? 'å»ºè­°è¨­å®šä»¥æŒ‡å®šä¸»è¦é é¢' : '', code: '<link rel="canonical" href="https://example.com/page">' });
                var robotsEl = doc.querySelector('meta[name="robots"]'); checkData.push({ type: 'check', name: 'Robots Meta æŒ‡ä»¤', status: robotsEl ? 'good' : 'warning', value: safeAttr(robotsEl, 'content') || 'æœªè¨­å®š', info: 'æ§åˆ¶æœå°‹å¼•æ“ç´¢å¼•è¡Œç‚º', suggestion: !robotsEl ? 'å»ºè­°è¨­å®šç´¢å¼•æŒ‡ä»¤' : '', code: '<meta name="robots" content="index, follow">' });
                var faviconEl = doc.querySelector('link[rel="icon"], link[rel="shortcut icon"]'); checkData.push({ type: 'check', name: 'Favicon ç¶²ç«™åœ–ç¤º', status: faviconEl ? 'good' : 'warning', value: safeAttr(faviconEl, 'href') || 'æœªè¨­å®š', info: 'æå‡å“ç‰Œè­˜åˆ¥èˆ‡ä½¿ç”¨è€…é«”é©—', suggestion: !faviconEl ? 'å»ºè­°æ·»åŠ ç¶²ç«™åœ–ç¤º' : '', code: '<link rel="icon" href="/favicon.ico">' });
                var themeColorEl = doc.querySelector('meta[name="theme-color"]'); checkData.push({ type: 'check', name: 'Theme Color ä¸»é¡Œè‰²', status: themeColorEl ? 'good' : 'warning', value: safeAttr(themeColorEl, 'content') || 'æœªè¨­å®š', info: 'è¡Œå‹•è£ç½®ç€è¦½å™¨çš„ä¸»é¡Œé¡è‰²', suggestion: !themeColorEl ? 'å»ºè­°è¨­å®šä»¥æå‡è¡Œå‹•é«”é©—' : '', code: '<meta name="theme-color" content="#667eea">' });
                var appleTouchIcon = doc.querySelector('link[rel="apple-touch-icon"]'); checkData.push({ type: 'check', name: 'Apple Touch Icon', status: appleTouchIcon ? 'good' : 'warning', value: safeAttr(appleTouchIcon, 'href') || 'æœªè¨­å®š', info: 'iOS è£ç½®çš„ä¸»ç•«é¢åœ–ç¤º', suggestion: !appleTouchIcon ? 'å»ºè­°æ·»åŠ  180x180px åœ–ç¤º' : '', code: '<link rel="apple-touch-icon" href="/apple-touch-icon.png">' });
                var authorEl = doc.querySelector('meta[name="author"]'); checkData.push({ type: 'check', name: 'Author ä½œè€…è³‡è¨Š', status: authorEl ? 'good' : 'warning', value: safeAttr(authorEl, 'content') || 'æœªè¨­å®š', info: 'æ¨™ç¤ºå…§å®¹ä½œè€…', suggestion: !authorEl ? 'å»ºè­°æ·»åŠ ä½œè€…è³‡è¨Š' : '', code: '<meta name="author" content="ä½œè€…åç¨±">' });
                
                checkData.push({ type: 'subsection', text: 'ğŸ“± ç¤¾ç¾¤åª’é«”æ¨™ç±¤' });
                var ogTitle = doc.querySelector('meta[property="og:title"]'); var ogDesc = doc.querySelector('meta[property="og:description"]'); var ogImage = doc.querySelector('meta[property="og:image"]'); var ogUrl = doc.querySelector('meta[property="og:url"]'); var ogType = doc.querySelector('meta[property="og:type"]'); var ogCount = [ogTitle, ogDesc, ogImage].filter(Boolean).length; checkData.push({ type: 'check', name: 'Open Graph åŸºæœ¬æ¨™ç±¤', status: ogCount >= 3 ? 'good' : ogCount >= 2 ? 'warning' : 'error', value: 'å·²è¨­å®š ' + ogCount + ' / 3 å€‹æ ¸å¿ƒæ¨™ç±¤', info: 'Facebookã€LinkedIn åˆ†äº«', suggestion: ogCount < 3 ? 'å»ºè­°å®Œæ•´è¨­å®š og:title, og:description, og:image' : '', code: '<meta property="og:title" content="æ¨™é¡Œ">\n<meta property="og:description" content="æè¿°">\n<meta property="og:image" content="https://example.com/image.jpg">' });
                var ogAdvancedCount = [ogUrl, ogType].filter(Boolean).length; checkData.push({ type: 'check', name: 'Open Graph é€²éšæ¨™ç±¤', status: ogAdvancedCount >= 2 ? 'good' : ogAdvancedCount >= 1 ? 'warning' : 'warning', value: 'å·²è¨­å®š ' + ogAdvancedCount + ' / 2 å€‹', info: 'å®Œæ•´çš„ç¤¾ç¾¤åª’é«”å„ªåŒ–', suggestion: ogAdvancedCount < 2 ? 'å»ºè­°æ·»åŠ  og:url å’Œ og:type' : '', code: '<meta property="og:url" content="https://example.com/page">\n<meta property="og:type" content="website">' });
                var twitterCard = doc.querySelector('meta[name="twitter:card"]'); var twitterTitle = doc.querySelector('meta[name="twitter:title"]'); var twitterImage = doc.querySelector('meta[name="twitter:image"]'); var twitterCount = [twitterCard, twitterTitle, twitterImage].filter(Boolean).length; checkData.push({ type: 'check', name: 'Twitter Card', status: twitterCount >= 2 ? 'good' : twitterCount >= 1 ? 'warning' : 'warning', value: 'å·²è¨­å®š ' + twitterCount + ' / 3 å€‹', info: 'Twitter/X åˆ†äº«å¡ç‰‡', suggestion: twitterCount < 2 ? 'å»ºè­°å®Œæ•´è¨­å®š Twitter Card' : '', code: '<meta name="twitter:card" content="summary_large_image">\n<meta name="twitter:title" content="æ¨™é¡Œ">\n<meta name="twitter:image" content="åœ–ç‰‡ç¶²å€">' });
                
                checkData.push({ type: 'subsection', text: 'ğŸ“ å…§å®¹çµæ§‹' });
                var h1List = doc.querySelectorAll('h1'); var h1Count = h1List.length; var h1Text = Array.from(h1List).slice(0, 2).map(safeText).join(' | '); checkData.push({ type: 'check', name: 'H1 ä¸»æ¨™é¡Œ', status: h1Count === 1 ? 'good' : h1Count > 1 ? 'warning' : 'error', value: h1Text || 'æœªæ‰¾åˆ°', info: 'æ‰¾åˆ° ' + h1Count + ' å€‹ (å»ºè­° 1 å€‹)', suggestion: h1Count === 0 ? 'å¿…é ˆæœ‰ H1' : h1Count > 1 ? 'å»ºè­°åªæœ‰ 1 å€‹' : '', code: '<h1>ä¸»è¦æ¨™é¡Œ</h1>' });
                var h2List = doc.querySelectorAll('h2'); checkData.push({ type: 'check', name: 'H2 å‰¯æ¨™é¡Œ', status: h2List.length > 0 ? 'good' : 'warning', value: `æ‰¾åˆ° ${h2List.length} å€‹`, info: 'æœ‰åŠ©æ–¼å»ºç«‹å…§å®¹å±¤æ¬¡çµæ§‹', suggestion: h2List.length === 0 ? 'å»ºè­°è‡³å°‘ä½¿ç”¨ä¸€å€‹ H2 ä¾†çµ„ç¹”å…§å®¹' : '', code: '<h2>å‰¯æ¨™é¡Œ</h2>' });
                var h3Count = doc.querySelectorAll('h3').length; var h4Count = doc.querySelectorAll('h4').length; var h5Count = doc.querySelectorAll('h5').length; var h6Count = doc.querySelectorAll('h6').length; var totalHeadings = h1Count + h2List.length + h3Count + h4Count + h5Count + h6Count; checkData.push({ type: 'check', name: 'æ¨™é¡Œå±¤æ¬¡çµæ§‹', status: totalHeadings >= 3 ? 'good' : totalHeadings >= 1 ? 'warning' : 'error', value: `H1:${h1Count}, H2:${h2List.length}, H3:${h3Count}, H4:${h4Count}`, info: 'å®Œæ•´çš„å…§å®¹å±¤æ¬¡æœ‰åŠ©æ–¼ SEO', suggestion: totalHeadings < 3 ? 'å»ºè­°ä½¿ç”¨å¤šå±¤æ¬¡æ¨™é¡Œçµ„ç¹”å…§å®¹' : '', code: '<h1>ä¸»æ¨™é¡Œ</h1>\n<h2>æ¬¡æ¨™é¡Œ</h2>\n<h3>å°æ¨™é¡Œ</h3>' });
                var imgList = doc.querySelectorAll('img'); var imgCount = imgList.length; var imgNoAlt = Array.from(imgList).filter(img => !safeAttr(img, 'alt')).length; checkData.push({ type: 'check', name: 'åœ–ç‰‡ Alt å±¬æ€§', status: imgNoAlt === 0 ? 'good' : 'warning', value: imgCount + ' å¼µåœ–ç‰‡ï¼Œ' + imgNoAlt + ' å¼µç¼ºå°‘ alt', info: 'SEO å’Œç„¡éšœç¤™', suggestion: imgNoAlt > 0 ? 'å»ºè­°ç‚ºæ‰€æœ‰åœ–ç‰‡æ·»åŠ æè¿°æ€§çš„ alt å±¬æ€§' : '', code: '<img src="image.jpg" alt="æè¿°åœ–ç‰‡å…§å®¹">' });
                var imgNoDimensions = Array.from(imgList).filter(img => !safeAttr(img, 'width') || !safeAttr(img, 'height')).length; checkData.push({ type: 'check', name: 'åœ–ç‰‡å°ºå¯¸å±¬æ€§', status: imgNoDimensions === 0 ? 'good' : 'warning', value: imgCount + ' å¼µåœ–ç‰‡ï¼Œ' + imgNoDimensions + ' å¼µç¼ºå°‘å°ºå¯¸', info: 'é˜²æ­¢ç‰ˆé¢è·³å‹•ï¼Œæå‡æ•ˆèƒ½', suggestion: imgNoDimensions > 0 ? 'å»ºè­°ç‚ºæ‰€æœ‰åœ–ç‰‡è¨­å®š width å’Œ height å±¬æ€§' : '', code: '<img src="image.jpg" alt="æè¿°" width="800" height="600">' });
                var imgWithLazyLoad = Array.from(imgList).filter(img => safeAttr(img, 'loading') === 'lazy').length; checkData.push({ type: 'check', name: 'åœ–ç‰‡å»¶é²è¼‰å…¥', status: imgWithLazyLoad > 0 ? 'good' : 'warning', value: imgWithLazyLoad + ' / ' + imgCount + ' å¼µä½¿ç”¨å»¶é²è¼‰å…¥', info: 'æå‡é é¢è¼‰å…¥é€Ÿåº¦', suggestion: imgWithLazyLoad === 0 && imgCount > 3 ? 'å»ºè­°ç‚ºéé¦–å±åœ–ç‰‡æ·»åŠ  loading="lazy"' : '', code: '<img src="image.jpg" alt="æè¿°" loading="lazy">' });
                var linkList = doc.querySelectorAll('a'); var linkCount = linkList.length; var externalLinks = Array.from(linkList).filter(a => { var href = safeAttr(a, 'href'); return href && (href.startsWith('http://') || href.startsWith('https://')) && !href.includes(window.location.hostname); }); var externalCount = externalLinks.length; var externalNoRel = externalLinks.filter(a => !safeAttr(a, 'rel')).length; checkData.push({ type: 'check', name: 'å¤–éƒ¨é€£çµå®‰å…¨å±¬æ€§', status: externalNoRel === 0 ? 'good' : 'warning', value: externalCount + ' å€‹å¤–éƒ¨é€£çµï¼Œ' + externalNoRel + ' å€‹ç¼ºå°‘ rel å±¬æ€§', info: 'å®‰å…¨æ€§å’Œ SEO', suggestion: externalNoRel > 0 ? 'å»ºè­°ç‚ºå¤–éƒ¨é€£çµæ·»åŠ  rel="noopener" æˆ– rel="nofollow"' : '', code: '<a href="https://external.com" rel="noopener noreferrer">å¤–éƒ¨é€£çµ</a>' });
                var bodyText = safeText(doc.body); var wordCount = bodyText.replace(/\s+/g, ' ').trim().length; checkData.push({ type: 'check', name: 'é é¢å…§å®¹é•·åº¦', status: wordCount >= 300 ? 'good' : wordCount >= 100 ? 'warning' : 'error', value: wordCount + ' å­—å…ƒ', info: 'å……å¯¦çš„å…§å®¹æœ‰åŠ©æ–¼ SEO', suggestion: wordCount < 300 ? 'å»ºè­°å¢åŠ é é¢å…§å®¹è‡³å°‘ 300 å­—å…ƒä»¥ä¸Š' : '', code: '' });
                
                checkData.push({ type: 'subsection', text: 'âš¡ æ•ˆèƒ½å„ªåŒ–' });
                var preloadLinks = doc.querySelectorAll('link[rel="preload"], link[rel="prefetch"], link[rel="dns-prefetch"], link[rel="preconnect"]'); checkData.push({ type: 'check', name: 'è³‡æºé è¼‰å„ªåŒ–', status: preloadLinks.length > 0 ? 'good' : 'warning', value: 'ä½¿ç”¨ ' + preloadLinks.length + ' å€‹é è¼‰æŒ‡ä»¤', info: 'æå‡é é¢è¼‰å…¥é€Ÿåº¦', suggestion: preloadLinks.length === 0 ? 'å»ºè­°ä½¿ç”¨ preload/prefetch å„ªåŒ–é—œéµè³‡æº' : '', code: '<link rel="preload" href="font.woff2" as="font" crossorigin>\n<link rel="dns-prefetch" href="https://fonts.googleapis.com">' });
                var inlineStyles = doc.querySelectorAll('[style]'); var inlineStyleCount = inlineStyles.length; checkData.push({ type: 'check', name: 'è¡Œå…§æ¨£å¼ä½¿ç”¨', status: inlineStyleCount <= 5 ? 'good' : inlineStyleCount <= 20 ? 'warning' : 'error', value: 'æ‰¾åˆ° ' + inlineStyleCount + ' è™•', info: 'éå¤šè¡Œå…§æ¨£å¼å½±éŸ¿ç¶­è­·æ€§', suggestion: inlineStyleCount > 20 ? 'å»ºè­°æ¸›å°‘è¡Œå…§æ¨£å¼ï¼Œæ”¹ç”¨ CSS é¡åˆ¥' : '', code: '<!-- å°‡æ¨£å¼ç§»è‡³ CSS æª”æ¡ˆ -->\n<div class="container">å…§å®¹</div>' });
                
                checkData.push({ type: 'section', text: 'GEO ç”Ÿæˆå¼å¼•æ“å„ªåŒ–ï¼ˆAI æœå°‹ï¼‰' });
                checkData.push({ type: 'subsection', text: 'ğŸ¤– çµæ§‹åŒ–è³‡æ–™' });
                
                // === [MODIFIED] START: Schema Logic Improvement ===
                const schemaScripts = doc.querySelectorAll('script[type="application/ld+json"]');
                let allFoundTypes = [];
                let hasArticle = false, hasFAQ = false, hasBreadcrumb = false, hasOrganization = false, hasWebSite = false, hasWebPage = false;

                schemaScripts.forEach(script => {
                    try {
                        const data = JSON.parse(script.textContent);
                        const graph = data['@graph'];
                        const items = graph ? graph : [data];

                        items.forEach(item => {
                            const type = item['@type'];
                            if (Array.isArray(type)) {
                                allFoundTypes.push(...type);
                            } else if (type) {
                                allFoundTypes.push(type);
                            }
                        });
                    } catch (e) {
                        console.warn('Could not parse JSON-LD: ', e);
                    }
                });
                
                allFoundTypes = [...new Set(allFoundTypes)]; // ç§»é™¤é‡è¤‡é …ç›®

                hasArticle = allFoundTypes.some(t => ['Article', 'BlogPosting', 'NewsArticle'].includes(t));
                hasFAQ = allFoundTypes.includes('FAQPage');
                hasBreadcrumb = allFoundTypes.includes('BreadcrumbList');
                hasOrganization = allFoundTypes.some(t => ['Organization', 'LocalBusiness'].includes(t));
                hasWebSite = allFoundTypes.includes('WebSite');
                hasWebPage = allFoundTypes.includes('WebPage');
                
                const basicSchemaTypes = ['Article', 'BlogPosting', 'NewsArticle', 'FAQPage', 'BreadcrumbList', 'Organization', 'LocalBusiness', 'WebSite', 'WebPage', 'ListItem', 'Question', 'Answer', 'EntryPoint', 'PostalAddress', 'ContactPoint', 'ImageObject', 'Offer', 'GeoCoordinates'];
                const foundAdvancedTypes = allFoundTypes.filter(type => !basicSchemaTypes.includes(type));
                const advancedSchemaCount = foundAdvancedTypes.length;
                // === [MODIFIED] END: Schema Logic Improvement ===

                var schemaScore = [hasArticle, hasFAQ, hasBreadcrumb, hasOrganization, hasWebSite, hasWebPage].filter(Boolean).length; checkData.push({ type: 'check', name: 'çµæ§‹åŒ–è³‡æ–™å®Œæ•´åº¦', status: schemaScore >= 3 ? 'good' : schemaScore >= 1 ? 'warning' : 'error', value: 'å·²è¨­å®š ' + schemaScore + ' / 6 ç¨®å¸¸ç”¨é¡å‹', info: 'AI æœå°‹å¼•æ“çš„é‡è¦ä¾æ“š', suggestion: schemaScore < 3 ? 'å»ºè­°æ·»åŠ æ›´å¤šçµæ§‹åŒ–è³‡æ–™é¡å‹' : '', code: '<script type="application/ld+json">\n{\n  "@context": "https://schema.org",\n  "@type": "WebSite",\n  "name": "ç¶²ç«™åç¨±",\n  "url": "https://example.com"\n}\n<' + '/script>' });
                checkData.push({ type: 'check', name: 'Article Schema', status: hasArticle ? 'good' : 'warning', value: hasArticle ? 'å·²è¨­å®š' : 'æœªè¨­å®š', info: 'AI ç†è§£æ–‡ç« å…§å®¹', suggestion: !hasArticle ? 'é©åˆéƒ¨è½æ ¼å’Œæ–°èç¶²ç«™' : '', code: '<script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"æ–‡ç« æ¨™é¡Œ","author":{"@type":"Person","name":"ä½œè€…"},"datePublished":"2025-01-01"}<' + '/script>' });
                checkData.push({ type: 'check', name: 'FAQPage Schema', status: hasFAQ ? 'good' : 'warning', value: hasFAQ ? 'å·²è¨­å®š' : 'æœªè¨­å®š', info: 'AI æœ€æ„›çš„æ ¼å¼ï¼Œæ˜“æ–¼å¼•ç”¨', suggestion: !hasFAQ ? 'éå¸¸é©åˆå•ç­”å‹å…§å®¹' : '', code: '<script type="application/ld+json">{"@context":"https://schema.org","@type":"FAQPage","mainEntity":[{"@type":"Question","name":"å•é¡Œï¼Ÿ","acceptedAnswer":{"@type":"Answer","text":"ç­”æ¡ˆ"}}]}<' + '/script>' });
                checkData.push({ type: 'check', name: 'Breadcrumb Schema', status: hasBreadcrumb ? 'good' : 'warning', value: hasBreadcrumb ? 'å·²è¨­å®š' : 'æœªè¨­å®š', info: 'å¹«åŠ© AI ç†è§£ç¶²ç«™çµæ§‹', suggestion: !hasBreadcrumb ? 'å»ºè­°æ·»åŠ éºµåŒ…å±‘å°èˆª' : '', code: '<script type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"é¦–é ","item":"https://example.com"}]}<' + '/script>' });
                checkData.push({ type: 'check', name: 'Organization Schema', status: hasOrganization ? 'good' : 'warning', value: hasOrganization ? 'å·²è¨­å®š' : 'æœªè¨­å®š', info: 'å¹«åŠ© AI å»ºç«‹å“ç‰Œå¯¦é«”', suggestion: !hasOrganization ? 'ä¼æ¥­ç¶²ç«™å¼·çƒˆå»ºè­°æ·»åŠ ' : '', code: '<script type="application/ld+json">{"@context":"https://schema.org","@type":"Organization","name":"å…¬å¸åç¨±","url":"https://example.com","logo":"https://example.com/logo.png"}<' + '/script>' });
                checkData.push({ type: 'check', name: 'WebSite Schema', status: hasWebSite ? 'good' : 'warning', value: hasWebSite ? 'å·²è¨­å®š' : 'æœªè¨­å®š', info: 'å®šç¾©ç¶²ç«™çš„æœå°‹åŠŸèƒ½', suggestion: !hasWebSite ? 'å»ºè­°æ·»åŠ ç¶²ç«™ç´šåˆ¥çš„çµæ§‹åŒ–è³‡æ–™' : '', code: '<script type="application/ld+json">{"@context":"https://schema.org","@type":"WebSite","name":"ç¶²ç«™åç¨±","url":"https://example.com","potentialAction":{"@type":"SearchAction","target":"https://example.com/search?q={search_term_string}"}}<' + '/script>' });
                
                // === [MODIFIED] START: Advanced Schema Reporting ===
                const advancedValue = advancedSchemaCount > 0 ? `æ‰¾åˆ° ${advancedSchemaCount} ç¨®é€²éšé¡å‹: ${foundAdvancedTypes.join(', ')}` : 'å·²ä½¿ç”¨ 0 ç¨®é€²éšé¡å‹';
                checkData.push({ 
                    type: 'check', 
                    name: 'é€²éš Schema é¡å‹', 
                    status: advancedSchemaCount > 0 ? 'good' : 'warning', 
                    value: advancedValue, 
                    info: 'ä¾‹å¦‚: Service, Product, Person, Event, Recipe ç­‰', 
                    suggestion: advancedSchemaCount === 0 ? 'æ ¹æ“šå…§å®¹é¡å‹è€ƒæ…®æ·»åŠ æ›´å…·é«”çš„ Schema' : '', 
                    code: '<script type="application/ld+json">{"@context":"https://schema.org","@type":"Service","name":"æœå‹™åç¨±","description":"æœå‹™æè¿°..."}<' + '/script>' 
                });
                // === [MODIFIED] END: Advanced Schema Reporting ===

                checkData.push({ type: 'subsection', text: 'ğŸ—ï¸ èªç¾©åŒ– HTML' });
                var hasArticleTag = !!doc.querySelector('article'), hasSection = !!doc.querySelector('section'); var hasHeader = !!doc.querySelector('header'), hasMain = !!doc.querySelector('main'); var hasNav = !!doc.querySelector('nav'), hasFooter = !!doc.querySelector('footer'), hasAside = !!doc.querySelector('aside'); var semanticCount = [hasArticleTag, hasSection, hasHeader, hasMain, hasNav, hasFooter, hasAside].filter(Boolean).length; checkData.push({ type: 'check', name: 'èªç¾©åŒ–æ¨™ç±¤å®Œæ•´åº¦', status: semanticCount >= 4 ? 'good' : semanticCount >= 2 ? 'warning' : 'error', value: 'ä½¿ç”¨ ' + semanticCount + ' / 7 ç¨®', info: 'AI è­˜åˆ¥ç¶²é çµæ§‹çš„é—œéµ', suggestion: semanticCount < 4 ? 'å»ºè­°ä½¿ç”¨ article, section, header, main, nav, footer, aside' : '', code: '<body>\n  <header>ç¶²ç«™æ¨™é ­</header>\n  <nav>å°èˆª</nav>\n  <main>\n    <article>ä¸»è¦å…§å®¹</article>\n  </main>\n  <footer>ç¶²ç«™é å°¾</footer>\n</body>' });
                var ulCount = doc.querySelectorAll('ul').length; var olCount = doc.querySelectorAll('ol').length; var listCount = ulCount + olCount; checkData.push({ type: 'check', name: 'åˆ—è¡¨æ¨™ç±¤ä½¿ç”¨', status: listCount >= 2 ? 'good' : listCount >= 1 ? 'warning' : 'warning', value: `UL: ${ulCount}, OL: ${olCount}`, info: 'AI å®¹æ˜“è­˜åˆ¥å’Œå¼•ç”¨çš„æ ¼å¼', suggestion: listCount === 0 ? 'å»ºè­°ä½¿ç”¨ <ul> æˆ– <ol> çµ„ç¹”åˆ—è¡¨å…§å®¹' : '', code: '<ul>\n  <li>é …ç›® 1</li>\n  <li>é …ç›® 2</li>\n  <li>é …ç›® 3</li>\n</ul>' });
                var timeCount = doc.querySelectorAll('time').length; checkData.push({ type: 'check', name: 'Time æ™‚é–“æ¨™ç±¤', status: timeCount > 0 ? 'good' : 'warning', value: 'ä½¿ç”¨ ' + timeCount + ' å€‹', info: 'AI è­˜åˆ¥æ™‚é–“è³‡è¨Š', suggestion: timeCount === 0 ? 'å»ºè­°ä½¿ç”¨ <time> æ¨™è¨˜æ—¥æœŸå’Œæ™‚é–“' : '', code: '<time datetime="2025-01-01">2025å¹´1æœˆ1æ—¥</time>' });
                var strongCount = doc.querySelectorAll('strong').length; var emCount = doc.querySelectorAll('em').length; var emphasisCount = strongCount + emCount; checkData.push({ type: 'check', name: 'èªç¾©åŒ–å¼·èª¿æ¨™ç±¤', status: emphasisCount >= 3 ? 'good' : emphasisCount >= 1 ? 'warning' : 'warning', value: `Strong: ${strongCount}, Em: ${emCount}`, info: 'AI è­˜åˆ¥é‡é»å…§å®¹', suggestion: emphasisCount === 0 ? 'å»ºè­°ä½¿ç”¨ <strong> å’Œ <em> æ¨™è¨˜é‡é»' : '', code: '<p>é€™æ˜¯<strong>é‡è¦</strong>çš„å…§å®¹ï¼Œéœ€è¦<em>å¼·èª¿</em></p>' });
                
                checkData.push({ type: 'subsection', text: 'â™¿ ç„¡éšœç¤™å„ªåŒ–' });
                var ariaElements = doc.querySelectorAll('[role], [aria-label], [aria-labelledby], [aria-describedby]'); checkData.push({ type: 'check', name: 'ARIA ç„¡éšœç¤™æ¨™ç±¤', status: ariaElements.length >= 3 ? 'good' : ariaElements.length >= 1 ? 'warning' : 'warning', value: 'ä½¿ç”¨ ' + ariaElements.length + ' è™•', info: 'æå‡ç„¡éšœç¤™å’Œ AI ç†è§£', suggestion: ariaElements.length === 0 ? 'å»ºè­°æ·»åŠ  ARIA å±¬æ€§æå‡ç„¡éšœç¤™' : '', code: '<button aria-label="é—œé–‰å°è©±æ¡†">Ã—</button>\n<nav role="navigation" aria-label="ä¸»å°èˆª">...</nav>' });
                var formCount = doc.querySelectorAll('form').length; var labelCount = doc.querySelectorAll('label').length; var inputCount = doc.querySelectorAll('input, textarea, select').length; checkData.push({ type: 'check', name: 'è¡¨å–®ç„¡éšœç¤™æ¨™ç±¤', status: formCount > 0 && labelCount >= inputCount * 0.8 ? 'good' : formCount > 0 ? 'warning' : 'good', value: `${formCount} å€‹è¡¨å–®ï¼Œ${labelCount}/${inputCount} å€‹æ¬„ä½æœ‰æ¨™ç±¤`, info: 'è¡¨å–®æ¬„ä½æ‡‰é…å° label', suggestion: formCount > 0 && labelCount < inputCount ? 'å»ºè­°ç‚ºæ‰€æœ‰è¡¨å–®æ¬„ä½æ·»åŠ  <label>' : '', code: '<label for="email">é›»å­éƒµä»¶</label>\n<input type="email" id="email" name="email">' });
                
                displayResults(source);
            } catch (e) { console.error('åˆ†æéŒ¯èª¤:', e); hideLoading(); alert('åˆ†æ HTML æ™‚ç™¼ç”ŸéŒ¯èª¤'); }
        }

        function displayResults(source) {
            document.getElementById('results').classList.add('show');
            if (source === 'url') { document.getElementById('url-analyze-btn').style.display = 'none'; document.getElementById('url-results-buttons').style.display = 'block'; } 
            else if (source === 'code') { document.getElementById('code-analyze-btn').style.display = 'none'; document.getElementById('code-results-buttons').style.display = 'block'; }
            
            document.getElementById('outputCode').textContent = htmlCode;
            let goodCount = 0, warningCount = 0, errorCount = 0; checkData.forEach(item => { if (item.type !== 'check') return; if (item.status === 'good') goodCount++; else if (item.status === 'warning') warningCount++; else if (item.status === 'error') errorCount++; });
            const totalCount = goodCount + warningCount + errorCount; const score = totalCount > 0 ? Math.round((goodCount / totalCount) * 100) : 0;
            const summaryDiv = document.getElementById('summary'); summaryDiv.innerHTML = ''; summaryDiv.appendChild(createSummaryCard(score + '%', 'æ•´é«”åˆ†æ•¸')); summaryDiv.appendChild(createSummaryCard(goodCount, 'å„ªç§€é …ç›®')); summaryDiv.appendChild(createSummaryCard(warningCount, 'å¾…æ”¹å–„')); summaryDiv.appendChild(createSummaryCard(errorCount, 'éœ€è™•ç†'));
            const container = document.getElementById('checkResults'); container.innerHTML = ''; checkData.forEach(item => { if (item.type === 'section') { const el = document.createElement('div'); el.className = 'section-header'; el.textContent = item.text; container.appendChild(el); } else if (item.type === 'subsection') { const el = document.createElement('div'); el.className = 'subsection-header'; el.textContent = item.text; container.appendChild(el); } else if (item.type === 'check') { container.appendChild(createCheckItem(item)); } });
        }

        function createSummaryCard(num, text) { const card = document.createElement('div'); card.className = 'summary-card'; card.innerHTML = `<h3>${num}</h3><p>${text}</p>`; return card; }

        function createCheckItem(data) { const item = document.createElement('div'); item.className = 'check-item ' + data.status; const badgeContent = data.status === 'good' ? 'âœ“' : data.status === 'warning' ? 'âš ' : 'âœ•'; let html = `<div class="check-title"><span class="status-badge">${badgeContent}</span>${data.name}</div>`; if (data.value) html += `<div class="check-value">${data.value.replace(/</g, "&lt;")}</div>`; if (data.info) html += `<div class="check-info">${data.info}</div>`; if (data.suggestion) html += `<div class="check-suggestion">ğŸ’¡ ${data.suggestion}</div>`; if (data.code && data.status !== 'good') { html += `<div class="code-box">${data.code.replace(/</g, "&lt;")}</div>`; const copyBtn = document.createElement('button'); copyBtn.className = 'copy-btn'; copyBtn.textContent = 'ğŸ“‹ è¤‡è£½ä»£ç¢¼'; copyBtn.onclick = () => navigator.clipboard.writeText(data.code).then(() => alert('å·²è¤‡è£½')); item.innerHTML = html; item.appendChild(copyBtn); } else { item.innerHTML = html; } return item; }

        function optimizeCode() {
            if (!htmlCode) { alert('è«‹å…ˆåˆ†æ'); return; }

            const escapeHtml = (unsafe) => unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
            
            const doc = new DOMParser().parseFromString(htmlCode, 'text/html');
            let changesMade = false;

            const annotations = new Map();
            checkData.filter(item => item.status !== 'good' && item.suggestion).forEach(item => {
                const comment = `<!-- ğŸ’¡ ${item.name}: ${item.suggestion} -->`;
                let elements = [];
                 switch (item.name) {
                    case 'Title ç¶²é æ¨™é¡Œ': elements = [doc.querySelector('title')]; break;
                    case 'Meta Description': elements = [doc.querySelector('meta[name="description"]')]; break;
                    case 'H1 ä¸»æ¨™é¡Œ': elements = Array.from(doc.querySelectorAll('h1')); break;
                    case 'åœ–ç‰‡ Alt å±¬æ€§': elements = Array.from(doc.querySelectorAll('img')).filter(img => !safeAttr(img, 'alt')); break;
                }
                elements.filter(Boolean).forEach(el => annotations.set(el, comment));
            });

            const rebuildNode = (node) => {
                let functional = '', display = '';
                
                if (annotations.has(node)) {
                    const comment = annotations.get(node);
                    functional += `\n${comment}`;
                    display += `\n<span class="optimized-code">${escapeHtml(comment)}</span>`;
                    changesMade = true;
                }

                if (node.nodeType === Node.ELEMENT_NODE) {
                    let attrs = '';
                    for (const attr of node.attributes) { attrs += ` ${attr.name}="${escapeHtml(attr.value)}"`; }
                    
                    let tagName = node.tagName.toLowerCase();
                    if (tagName === 'html' && !node.lang) {
                        attrs += ' lang="zh-TW"';
                        changesMade = true;
                    }

                    functional += `\n<${tagName}${attrs}>`;
                    display += `\n<${tagName}${attrs.replace('lang="zh-TW"', '<span class="optimized-code">lang="zh-TW"</span>')}>`;
                    
                    if (tagName === 'head') {
                        let headInserts = '', displayHeadInserts = '';
                        const addTag = (tag) => {
                            headInserts += `\n  ${tag}`;
                            displayHeadInserts += `\n  <span class="optimized-code">${escapeHtml(tag)}</span>`;
                            changesMade = true;
                        };
                        if (!doc.querySelector('meta[charset]')) { addTag('<meta charset="UTF-8">'); }
                        if (!doc.querySelector('meta[name="viewport"]')) { addTag('<meta name="viewport" content="width=device-width, initial-scale=1.0">'); }
                        if (!doc.querySelector('title') && !annotations.has(node.querySelector('title'))) { addTag('<title>ç¶²ç«™æ¨™é¡Œ</title>'); }
                        if (!doc.querySelector('meta[name="description"]') && !annotations.has(node.querySelector('meta[name="description"]'))) { addTag('<meta name="description" content="ç¶²ç«™æè¿°">'); }
                        if (!doc.querySelector('link[rel="canonical"]')) { addTag('<link rel="canonical" href="åœ¨æ­¤è™•è²¼ä¸Šä¸»è¦ç¶²å€">'); }
                        if (!doc.querySelector('meta[property="og:title"]')) { addTag('<meta property="og:title" content="æ¨™é¡Œ">\n  <meta property="og:description" content="æè¿°">'); }
                        
                        functional += headInserts;
                        display += displayHeadInserts;
                    }
                    
                    for (const child of node.childNodes) {
                        const rebuilt = rebuildNode(child);
                        functional += rebuilt.functional;
                        display += rebuilt.display;
                    }

                    if (!['area', 'base', 'br', 'col', 'embed', 'hr', 'img', 'input', 'link', 'meta', 'param', 'source', 'track', 'wbr'].includes(tagName)) {
                        functional += `</${tagName}>`;
                        display += `&lt;/${tagName}&gt;`;
                    }
                } 
                else if (node.nodeType === Node.TEXT_NODE) {
                    functional += node.textContent;
                    display += escapeHtml(node.textContent);
                } else if (node.nodeType === Node.COMMENT_NODE) {
                    functional += `<!--${node.nodeValue}-->`;
                    display += `&lt;!--${escapeHtml(node.nodeValue)}--&gt;`;
                }
                
                return { functional, display };
            };

            const doctype = doc.doctype ? `<!DOCTYPE ${doc.doctype.name}>` : '<!DOCTYPE html>';
            const rebuilt = rebuildNode(doc.documentElement);

            if (changesMade) {
                htmlCode = doctype + rebuilt.functional;
                document.getElementById('outputCode').innerHTML = escapeHtml(doctype) + rebuilt.display;
                analyzeHTML(htmlCode, null);
                alert('âœ¨ å„ªåŒ–å®Œæˆï¼\n\nå·²è‡ªå‹•è£œä¸ŠåŸºç¤æ¨™ç±¤ï¼Œä¸¦åœ¨éœ€è¦æ‰‹å‹•ä¿®æ”¹çš„åœ°æ–¹åŠ å…¥äº†è¨»è§£å»ºè­°ï¼ˆæ¨™ç¤ºç‚ºç´…è‰²ï¼‰ã€‚');
            } else {
                alert('âœ… åŸºç¤æ¨™ç±¤æª¢æŸ¥å®Œç•¢ï¼\n\næ‚¨çš„ç¨‹å¼ç¢¼å·²åŒ…å«æ‰€æœ‰å¯ã€Œè‡ªå‹•æ·»åŠ ã€çš„åŸºç¤æ¨™ç±¤ã€‚\nå°æ–¼ã€Œå¾…æ”¹å–„ã€çš„é …ç›®ï¼Œä»éœ€æ‚¨åƒè€ƒå»ºè­°æ‰‹å‹•é€²è¡Œèª¿æ•´ã€‚');
            }
        }

        function downloadCode() {
            if (!htmlCode) { alert('æ²’æœ‰å…§å®¹'); return; }
            const blob = new Blob([htmlCode], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'optimized.html';
            a.click(); URL.revokeObjectURL(url);
        }
        
        function copyFullCode() {
            if (!htmlCode) { alert('æ²’æœ‰å…§å®¹å¯è¤‡è£½'); return; }
            navigator.clipboard.writeText(htmlCode).then(() => {
                alert('âœ… å„ªåŒ–å¾Œçš„å®Œæ•´ä»£ç¢¼å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
            }, () => {
                alert('âŒ è¤‡è£½å¤±æ•—ï¼Œæ‚¨çš„ç€è¦½å™¨å¯èƒ½ä¸æ”¯æ´æ­¤åŠŸèƒ½ã€‚');
            });
        }

        function downloadSuggestions() {
            if (checkData.length === 0) { 
                alert('âŒ æ²’æœ‰åˆ†ææ•¸æ“šï¼Œè«‹å…ˆé€²è¡Œåˆ†æ'); 
                return; 
            }

            let goodCount = 0, warningCount = 0, errorCount = 0;
            checkData.forEach(item => {
                if (item.type !== 'check') return;
                if (item.status === 'good') goodCount++;
                else if (item.status === 'warning') warningCount++;
                else if (item.status === 'error') errorCount++;
            });
            const totalCount = goodCount + warningCount + errorCount;
            const score = totalCount > 0 ? Math.round((goodCount / totalCount) * 100) : 0;

            const reportHTML = `<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEO & GEO å„ªåŒ–å»ºè­°å ±å‘Š - ${new Date().toLocaleDateString('zh-TW')}</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            background: #f5f7fa;
            padding: 40px 20px;
            line-height: 1.8;
        }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); overflow: hidden; }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 60px 40px;
            text-align: center;
        }
        .header h1 { font-size: 2.5rem; margin-bottom: 15px; }
        .header .date { font-size: 1rem; opacity: 0.9; }
        .summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            padding: 40px;
            background: #f8f9fa;
        }
        .summary-card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }
        .summary-card h2 { font-size: 3rem; margin-bottom: 10px; }
        .summary-card.score h2 { color: ${score >= 80 ? '#10b981' : score >= 60 ? '#f59e0b' : '#ef4444'}; }
        .summary-card.good h2 { color: #10b981; }
        .summary-card.warning h2 { color: #f59e0b; }
        .summary-card.error h2 { color: #ef4444; }
        .summary-card p { color: #6b7280; font-size: 1rem; }
        .content { padding: 40px; }
        .section-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            margin: 40px 0 20px 0;
            border-radius: 10px;
            font-size: 1.8rem;
            font-weight: 700;
        }
        .subsection-header {
            background: #f3f4f6;
            padding: 15px 20px;
            margin: 30px 0 15px 0;
            border-radius: 8px;
            font-size: 1.3rem;
            font-weight: 700;
            color: #374151;
            border-left: 5px solid #667eea;
        }
        .check-item {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            border: 2px solid #e5e7eb;
            page-break-inside: avoid;
        }
        .check-item.good {
            border-left: 5px solid #10b981;
            background: #f0fdf4;
        }
        .check-item.warning {
            border-left: 5px solid #f59e0b;
            background: #fffbeb;
        }
        .check-item.error {
            border-left: 5px solid #ef4444;
            background: #fef2f2;
        }
        .check-title {
            font-weight: 700;
            font-size: 1.2rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }
        .status-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            margin-right: 12px;
            font-weight: 700;
            font-size: 1.1rem;
        }
        .good .status-badge { background: #10b981; color: white; }
        .warning .status-badge { background: #f59e0b; color: white; }
        .error .status-badge { background: #ef4444; color: white; }
        .check-value {
            background: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            margin: 12px 0;
            font-family: monospace;
            font-size: 0.95rem;
            word-break: break-all;
            border: 1px solid #e5e7eb;
        }
        .check-info {
            color: #6b7280;
            font-size: 1rem;
            margin: 10px 0;
            padding-left: 5px;
        }
        .check-suggestion {
            background: #eff6ff;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            color: #1e40af;
            font-size: 1rem;
            border-left: 4px solid #3b82f6;
        }
        .check-suggestion strong { color: #1e3a8a; }
        .code-box {
            background: #1e293b;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9rem;
            overflow-x: auto;
            white-space: pre-wrap;
            border: 1px solid #334155;
        }
        .footer {
            background: #f8f9fa;
            padding: 30px 40px;
            text-align: center;
            color: #6b7280;
            border-top: 2px solid #e5e7eb;
        }
        .footer p { margin: 5px 0; }
        .print-note {
            background: #fef3c7;
            border: 2px solid #fbbf24;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            text-align: center;
        }
        @media print {
            body { background: white; padding: 0; }
            .container { box-shadow: none; }
            .print-note { display: none; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ SEO & GEO å„ªåŒ–å»ºè­°å ±å‘Š</h1>
            <p class="date">ç”Ÿæˆæ—¥æœŸï¼š${new Date().toLocaleString('zh-TW', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            })}</p>
        </div>

        <div class="summary">
            <div class="summary-card score">
                <h2>${score}%</h2>
                <p>æ•´é«”è©•åˆ†</p>
            </div>
            <div class="summary-card good">
                <h2>${goodCount}</h2>
                <p>âœ… å„ªç§€é …ç›®</p>
            </div>
            <div class="summary-card warning">
                <h2>${warningCount}</h2>
                <p>âš ï¸ å¾…æ”¹å–„é …ç›®</p>
            </div>
            <div class="summary-card error">
                <h2>${errorCount}</h2>
                <p>âŒ éœ€è™•ç†é …ç›®</p>
            </div>
        </div>

        <div class="content">
            <div class="print-note">
                <strong>ğŸ’¡ æç¤ºï¼š</strong>æ‚¨å¯ä»¥æŒ‰ Ctrl+P (Windows) æˆ– Cmd+P (Mac) åˆ—å°æˆ–å„²å­˜ç‚º PDF
            </div>

            ${generateCheckItemsHTML()}
        </div>

        <div class="footer">
            <p><strong>SEO & GEO å®Œæ•´å„ªåŒ–æª¢æŸ¥å·¥å…·</strong></p>
            <p>æœ¬å ±å‘Šç”±ç³»çµ±è‡ªå‹•ç”Ÿæˆï¼Œå…±æª¢æŸ¥ ${totalCount} å€‹é …ç›®</p>
            <p>å»ºè­°å®šæœŸé‡æ–°æª¢æŸ¥ä»¥ä¿æŒç¶²ç«™å„ªåŒ–ç‹€æ…‹</p>
        </div>
    </div>
</body>
</html>`;

            const blob = new Blob([reportHTML], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `SEOå„ªåŒ–å»ºè­°å ±å‘Š_${new Date().toISOString().split('T')[0]}.html`;
            a.click();
            URL.revokeObjectURL(url);

            alert('âœ… å„ªåŒ–å»ºè­°å ±å‘Šå·²ä¸‹è¼‰ï¼\n\nğŸ“„ æ‚¨å¯ä»¥ï¼š\nâ€¢ ç”¨ç€è¦½å™¨é–‹å•ŸæŸ¥çœ‹\nâ€¢ åˆ—å°æˆ–å„²å­˜ç‚º PDF\nâ€¢ åˆ†äº«çµ¦åœ˜éšŠæˆå“¡');
        }

        function generateCheckItemsHTML() {
            let html = '';
            checkData.forEach(item => {
                if (item.type === 'section') {
                    html += `<div class="section-header">${escapeHtmlForReport(item.text)}</div>`;
                } else if (item.type === 'subsection') {
                    html += `<div class="subsection-header">${escapeHtmlForReport(item.text)}</div>`;
                } else if (item.type === 'check') {
                    const badgeContent = item.status === 'good' ? 'âœ“' : item.status === 'warning' ? 'âš ' : 'âœ•';
                    html += `
                        <div class="check-item ${item.status}">
                            <div class="check-title">
                                <span class="status-badge">${badgeContent}</span>
                                <span>${escapeHtmlForReport(item.name)}</span>
                            </div>`;
                    
                    if (item.value) {
                        html += `<div class="check-value">${escapeHtmlForReport(item.value)}</div>`;
                    }
                    
                    if (item.info) {
                        html += `<div class="check-info">â„¹ï¸ ${escapeHtmlForReport(item.info)}</div>`;
                    }
                    
                    if (item.suggestion) {
                        html += `<div class="check-suggestion"><strong>ğŸ’¡ å„ªåŒ–å»ºè­°ï¼š</strong>${escapeHtmlForReport(item.suggestion)}</div>`;
                    }
                    
                    if (item.code && item.status !== 'good') {
                        html += `<div class="code-box">${escapeHtmlForReport(item.code)}</div>`;
                    }
                    
                    html += `</div>`;
                }
            });
            return html;
        }

        function escapeHtmlForReport(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showLoading() {
            document.getElementById('loading').classList.add('show');
            document.getElementById('results').classList.remove('show');
            document.getElementById('url-analyze-btn').style.display = 'block';
            document.getElementById('url-results-buttons').style.display = 'none';
            document.getElementById('code-analyze-btn').style.display = 'block';
            document.getElementById('code-results-buttons').style.display = 'none';
        }

        function hideLoading() {
            document.getElementById('loading').classList.remove('show');
        }
    </script>
</body>
</html>